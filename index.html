<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文遊戲大雜燴：完整版</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 定義可愛的卡通字體，使用 Inter 搭配圓角和粗體營造童趣感 */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* 游標閃爍動畫 */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* 按鈕基礎樣式 */
        .key-btn {
            height: 60px; /* Base height */
            transition: all 0.1s;
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }

        /* 遊戲卡片樣式 - Dino Egg Match */
        .dino-card {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* 蛋形按鈕 */
            border: 4px solid #F0B5C2;
            background-color: #FFEC99;
            cursor: pointer;
            transition: all 0.5s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .dino-card.flipped {
            transform: rotateY(180deg);
        }
        .dino-card-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .dino-card-front {
            background-color: #BDE0FE; /* 蛋殼藍 */
            color: #1E40AF;
        }
        .dino-card-back {
            background-color: #F8F8F8; /* 內容白 */
            color: #333;
            transform: rotateY(180deg);
        }
        .dino-card.matched {
            background-color: #90EE90;
            border-color: #3CB371;
            cursor: default;
        }

        /* Robot Puzzle (拖曳目標樣式) */
        .robot-target {
            min-height: 80px;
            width: 80px;
            border: 3px dashed #7B68EE;
            background-color: #E6E6FA;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .robot-target.filled {
            border: 3px solid #3CB371;
            background-color: #90EE90;
            cursor: pointer;
        }
        .robot-part {
            background-color: #FFD700; /* 金屬黃 */
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: grab;
            box-shadow: 0 4px 0 0 #B8860B;
            transition: all 0.1s;
        }
        .robot-part:active {
            box-shadow: 0 1px 0 0 #B8860B;
            transform: translateY(3px);
        }
        
        /* Superhero Action 樣式 */
        .superhero-option {
            background-color: #BDE0FE;
            color: #1E40AF;
            font-weight: bold;
            box-shadow: 0 4px 0 0 #87CEEB;
        }

        /* Grammar Parking Lot 樣式 */
        .parking-spot {
            background-color: #F0F8FF;
            border: 2px solid #ADD8E6;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 0 0 #87CEEB;
        }
        .parking-spot.correct {
            background-color: #90EE90;
            border-color: #3CB371;
        }
        .car-anim {
            transition: transform 1s ease-in-out;
        }

        /* Who's Lying? (Game 5) 樣式 */
        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) scale(1.02); }
            20%, 40%, 60%, 80% { transform: translateX(5px) scale(1.02); }
        }
        .shaking {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes tongue {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(15px); opacity: 1; }
        }
        .tongue-container {
             position: absolute;
             bottom: 0px;
             left: 50%;
             transform: translateX(-50%);
             z-index: 10;
        }
        .tongue-out {
             display: inline-block;
             animation: tongue 0.5s forwards;
             color: #FF4500;
             font-size: 2rem;
        }

    </style>

    <script>
        // 設定 Tailwind 配置, 使用柔和可愛的馬卡龍配色
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      // 主題粉 (柔和可愛)
                        'secondary-blue': '#BDE0FE',    // 輔助藍
                        'accent-yellow': '#FFEC99',     // 強調黃
                        'background-light': '#F8F8F8',  // 淺背景
                        'keyboard-bg': '#FFF5D6',       // 鍵盤區塊背景
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    // 按鈕立體陰影
                        'key-active': '0 2px 0 0 #D1A3A3', // 按下時的陰影
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- 訊息提示框 -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- 頂部標題與導航 -->
    <header class="w-full max-w-4xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- 可愛小豬圖示 (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.17157 9 9 9Z" fill="#FF8FAB"/>
                <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/>
                <circle cx="11" cy="13" r="1" fill="#FF8FAB"/>
                <circle cx="13" cy="13" r="1" fill="#FF8FAB"/>
            </svg>
            英文遊樂園
        </h1>
    </header>

    <!-- 導航列 -->
    <nav class="w-full max-w-4xl mb-6">
        <div class="flex flex-wrap justify-center space-x-2 md:space-x-4">
            <!-- Tab 按鈕使用事件委託 (Event Delegation) 處理 -->
            <button data-game="game1" id="tab-game1" onclick="changeGame('game1')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                🦖 詞彙配對
            </button>
            <button data-game="game2" id="tab-game2" onclick="changeGame('game2')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                🤖 字母拼圖
            </button>
            <button data-game="game3" id="tab-game3" onclick="changeGame('game3')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                🦸 動作指令
            </button>
            <button data-game="game4" id="tab-game4" onclick="changeGame('game4')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                🚗 文法停車場
            </button>
            <!-- 替換為 Who's Lying? -->
            <button data-game="game5" id="tab-game5" onclick="changeGame('game5')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                🤥 誰說謊了?
            </button>
            <!-- 單字後台 Tab -->
            <button data-game="admin" id="tab-admin" onclick="changeGame('admin')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ⚙️ 單字後台
            </button>
        </div>
    </nav>

    <!-- 主內容區 -->
    <main id="game-content" class="w-full max-w-4xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[500px]">
        <!-- 內容由 JS 渲染 -->
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">正在載入應用程式...</p>
        </div>
    </main>

    <!-- 全域狀態與設定 -->
    <script>
        // 字母表 (小寫)
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split(''); 
        const LOCAL_STORAGE_KEY = 'G_CustomWords_Unified_V2'; // 統一的 localStorage key
        
        // 內建單字庫 - 僅在自訂單字為空時使用
        const DICTIONARY_MAP = {
            game1: [ // Dino Egg Match: Noun/Emoji pairs (Word, Emoji)
                { word: "T-REX", image: "🦖" }, { word: "EGG", image: "🥚" }, { word: "YELLOW", image: "🟡" }, 
                { word: "THREE", image: "3️⃣" }, { word: "RED", image: "🔴" }, { word: "CAR", image: "🚗" }
            ],
            game2: [ // Robot Letter Puzzle: Simple Spelling
                "ROBOT", "BIKE", "LION", "DUCK", "JUMP"
            ],
            game3: [ // Superhero Action: Action Verbs (Verb, Image/Emoji)
                { verb: "JUMP", image: "⬆️" }, { verb: "RUN", image: "💨" }, { verb: "FLY", image: "🦸" },
                { verb: "CLIMB", image: "🧗" }, { verb: "WALK", image: "🚶" }, { verb: "SIT", image: "🪑" }
            ],
            game4: [ // Grammar Parking Lot: Simple Sentences (Pattern, Options, Answer)
                { pattern: "I ____ HAPPY.", options: ["AM", "IS", "ARE"], answer: "AM" },
                { pattern: "HE ____ SAD.", options: ["AM", "IS", "ARE"], answer: "IS" },
                { pattern: "WE ____ FRIENDS.", options: ["AM", "IS", "ARE"], answer: "ARE" },
                { pattern: "THE APPLE IS ____ THE BOX.", options: ["IN", "ON", "UNDER"], answer: "IN" },
                { pattern: "THE CAT IS ____ THE CHAIR.", options: ["IN", "ON", "UNDER"], answer: "UNDER" }
            ],
            game5: [ // Who's Lying? (Statement, Answer)
                { statement: "A cat has four legs.", answer: "TRUE" },
                { statement: "The sun is green.", answer: "FALSE" },
                { statement: "You are a student.", answer: "TRUE" },
                { statement: "Fish can walk.", answer: "FALSE" }
            ]
        };

        const NUM_GAME1_CARDS = 8; // 4 pairs

        // 統一儲存從 localStorage 載入的自訂單字 (結構化)
        let localCustomWords = {
            game1: [], // Dino Egg: [{word: "...", image: "..."}]
            game2: [], // Robot Puzzle: [{word: "..."}]
            game3: [], // Superhero: [{word: "...", image: "..."}]
            game4: [], // Parking Lot: [{pattern: "...", options: "...", answer: "..."}]
            game5: []  // Who's Lying?: [{statement: "...", answer: "..."}]
        }; 

        let currentGame = 'game1';
        
        let state = {
            // Question Pools and Review System for Games 1-5
            pools: {
                game1: { pool: [], missed: [] },
                game2: { pool: [], missed: [] },
                game3: { pool: [], missed: [] },
                game4: { pool: [], missed: [] },
                game5: { pool: [], missed: [] },
            },

            // Game 1 (Dino Egg)
            g1_cards: [],
            g1_flipped: [],
            g1_matchCount: 0,
            g1_currentQuestionItem: null, // 紀錄當前問題對象 (來自 pool 或 missed)

            // Game 2 (Robot Puzzle)
            g2_currentWord: '',
            g2_shuffledLetters: [],
            g2_userLetters: [], 
            g2_targetLetters: [], 
            g2_currentQuestionItem: null,

            // Game 3 (Superhero Action)
            g3_currentAction: null, 
            g3_score: 0,
            g3_currentQuestionItem: null,

            // Game 4 (Parking Lot)
            g4_currentSentence: null,
            g4_isLocked: false,
            g4_currentQuestionItem: null,
            
            // Game 5 (Who's Lying?)
            g5_currentStatement: null,
            g5_gameStatus: 'ready',
            g5_shaker: { true: false, false: false }, // 紀錄哪個角色要震動
            g5_currentQuestionItem: null,

            // Admin
            admin_currentGameKey: 'game3' 
        };


        // --- TTS 相關工具函式 (使用瀏覽器 SpeechSynthesis) ---
        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                MessageBox.show("瀏覽器不支持語音播放功能。", true);
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => {
                    console.error("SpeechSynthesis error:", e);
                    MessageBox.show("語音播放失敗。", true);
                    resolve();
                };
                window.speechSynthesis.speak(utterance);
            });
        }


        // 錯誤處理模組
        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        // --- LocalStorage 存儲功能 ---
        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loadedData = stored ? JSON.parse(stored) : {};
                
                // 確保 loadedData 是有效的物件，並合併到 localCustomWords
                localCustomWords.game1 = Array.isArray(loadedData.game1) ? loadedData.game1 : [];
                localCustomWords.game2 = Array.isArray(loadedData.game2) ? loadedData.game2 : [];
                localCustomWords.game3 = Array.isArray(loadedData.game3) ? loadedData.game3 : [];
                localCustomWords.game4 = Array.isArray(loadedData.game4) ? loadedData.game4 : [];
                localCustomWords.game5 = Array.isArray(loadedData.game5) ? loadedData.game5 : [];

            } catch (e) {
                console.error("Error loading words from local storage:", e);
                // 載入失敗時，使用空列表
                localCustomWords = { game1: [], game2: [], game3: [], game4: [], game5: [] };
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localCustomWords));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("無法保存單字到您的瀏覽器。", true);
            }
        }
        
        /**
         * 獲取指定遊戲的單字庫 (優先自訂，否則內建)
         * @param {string} gameKey 'game1', 'game2', 'game3', 'game4', 'game5'
         * @returns {Array} 單字列表
         */
        function getWordList(gameKey) {
            const custom = localCustomWords[gameKey] || [];
            if (custom.length > 0) return custom;
            return DICTIONARY_MAP[gameKey] || [];
        }
        
        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        /**
         * 提取問題的唯一識別鍵，用於 pool/missed 比較
         * @param {object|string} item 問題對象
         * @param {string} gameKey 
         * @returns {string} 唯一識別鍵 (Word, Verb, Pattern, or Statement)
         */
        function getItemKey(item, gameKey) {
            if (typeof item === 'string') return item.toUpperCase(); // Game 2 (string-based)
            if (gameKey === 'game1' || gameKey === 'game2') return item.word.toUpperCase();
            if (gameKey === 'game3') return item.verb.toUpperCase();
            if (gameKey === 'game4') return item.pattern.toUpperCase();
            if (gameKey === 'game5') return item.statement; // Statement is key
            return null;
        }

        /**
         * 從 pool 或 missed 中抽取下一個問題
         * @param {string} gameKey 遊戲鍵
         * @returns {object|null} 抽到的項目和其來源 ('pool'/'missed')
         */
        function drawNextItem(gameKey) {
            const pools = state.pools[gameKey];
            const sourceList = getWordList(gameKey);

            // 1. 初始化或重設 Pool (如果都空了)
            if (pools.pool.length === 0 && pools.missed.length === 0) {
                if (sourceList.length === 0) return null;

                // 複製整個詞彙列表到 Pool
                pools.pool = [...sourceList];
                pools.missed = [];
                MessageBox.show(`[${gameKey}] 已開始新一輪單字學習！`, false);
            }

            let item = null;
            let source = '';

            if (pools.missed.length > 0) {
                // 2. 優先從 Missed 中抽 (不移除，直到答對)
                const index = Math.floor(Math.random() * pools.missed.length);
                item = pools.missed[index];
                source = 'missed';
            } else if (pools.pool.length > 0) {
                // 3. 從 Pool 中抽 (移除)
                const index = Math.floor(Math.random() * pools.pool.length);
                item = pools.pool.splice(index, 1)[0];
                source = 'pool';
            }
            
            // 將 item 轉換為物件形式 (即使是 Game 2 也要包裝成 {word: string} 以便統一處理)
            let questionItem = typeof item === 'string' ? { word: item } : item;

            return { item: questionItem, source: source };
        }

        /**
         * 處理答題結果，更新 pool 和 missed 列表
         * @param {string} gameKey 遊戲鍵
         * @param {object} item 當前問題對象
         * @param {boolean} isCorrect 是否答對
         * @param {string} source 來源 ('pool'/'missed')
         */
        function updatePools(gameKey, item, isCorrect, source) {
            const pools = state.pools[gameKey];
            const itemKey = getItemKey(item, gameKey);

            if (isCorrect) {
                // 答對: 從 missed 中移除 (如果存在)
                for (let i = pools.missed.length - 1; i >= 0; i--) {
                    if (getItemKey(pools.missed[i], gameKey) === itemKey) {
                        pools.missed.splice(i, 1);
                        break;
                    }
                }
                
            } else {
                // 答錯: 加入 missed (如果不在 missed 中，且不是剛從 pool 移除的新題)
                let alreadyMissed = pools.missed.some(missedItem => getItemKey(missedItem, gameKey) === itemKey);

                // 只有當它還不在 missed 列表中時才加入，避免重複累積
                if (!alreadyMissed) {
                    pools.missed.push(item);
                }
            }
        }


        // --- 核心應用程式控制 ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.getElementById(`tab-${gameName}`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); 

            switch (currentGame) {
                case 'game1':
                    initGame1(true); // Added initial flag
                    break;
                case 'game2':
                    initGame2(true);
                    break;
                case 'game3':
                    initGame3(true);
                    break;
                case 'game4':
                    initGame4(true); 
                    break;
                case 'game5':
                    initGame5(true);
                    break;
                case 'admin': 
                    renderWordAdmin();
                    break;
            }
        }

        window.onload = function() {
            setTabActive(currentGame);
            renderApp();
        }
    </script>


    <script>
        // --- 遊戲 1 (恐龍蛋詞彙配對) 邏輯 ---
        function initGame1(isInit = false) {
            if (isInit) {
                state.g1_matchCount = 0;
            }
            
            const requiredPairs = NUM_GAME1_CARDS / 2;
            const itemObj = drawNextItem('game1');

            if (!itemObj) {
                 MessageBox.show(`詞彙配對遊戲需要 ${requiredPairs} 組詞彙/圖片，請至後台 (遊戲1) 新增。`, true);
                 renderGame1(true);
                 return;
            }
            
            // 由於 Game 1 需要 4 組，所以我們需要檢查當前 pool + missed 總數是否足夠
            const availableItems = [...state.pools.game1.pool, ...state.pools.game1.missed];
            if (availableItems.length < requiredPairs) {
                 MessageBox.show(`[詞彙配對] 單字庫不足 ${requiredPairs} 組，請至後台 (遊戲1) 新增。`, true);
                 renderGame1(true);
                 return;
            }
            
            // 重設卡片狀態
            state.g1_cards = [];
            state.g1_flipped = [];
            state.g1_matchCount = 0;
            
            // 由於 drawNextItem 只能抽一個，這裡需要做特殊處理：確保抽到 4 個不重複的 item
            let selectedPairs = [];
            let itemKeysInPlay = new Set();

            // 確保第一個 (itemObj.item) 是其中一個
            selectedPairs.push(itemObj.item);
            itemKeysInPlay.add(getItemKey(itemObj.item, 'game1'));
            
            // 抽取剩餘的 3 個項目
            let tempPool = [...state.pools.game1.pool, ...state.pools.game1.missed].filter(item => !itemKeysInPlay.has(getItemKey(item, 'game1')));
            tempPool = shuffleArray(tempPool);
            
            for (let i = 0; selectedPairs.length < requiredPairs && i < tempPool.length; i++) {
                 selectedPairs.push(tempPool[i]);
                 itemKeysInPlay.add(getItemKey(tempPool[i], 'game1'));
            }

            // 最終確保只有 4 個，如果單字庫太少，這裡會出問題，但已經在上面檢查過了。
            
            // **處理 Pool 移除邏輯 (只移除新題，錯題保留)**
            selectedPairs.forEach(pair => {
                const key = getItemKey(pair, 'game1');
                // 如果是新題 (不在 Missed 中)，則從 Pool 中移除 (因為已經出過了)
                const isNewItem = !state.pools.game1.missed.some(missedItem => getItemKey(missedItem, 'game1') === key);
                if (isNewItem) {
                    const poolIndex = state.pools.game1.pool.findIndex(p => getItemKey(p, 'game1') === key);
                    if (poolIndex !== -1) {
                         state.pools.game1.pool.splice(poolIndex, 1);
                    }
                }
            });

            // 設置當前問題集 (用於判斷是否答對整個遊戲)
            state.g1_currentQuestionItem = selectedPairs;

            let cardValues = []; // FIX: Initialize cardValues here

            // 生成卡片 (與舊邏輯相同)
            selectedPairs.forEach((pair, index) => {
                const groupId = `match-${index}`; 
                cardValues.push({ id: crypto.randomUUID(), value: pair.image, type: 'image', groupId, matched: false, flipped: false, key: getItemKey(pair, 'game1') });
                cardValues.push({ id: crypto.randomUUID(), value: pair.word.toUpperCase(), type: 'word', groupId, matched: false, flipped: false, key: getItemKey(pair, 'game1') });
            });
            
            state.g1_cards = shuffleArray(cardValues);
            renderGame1();
        }

        function handleCardClickG1(id) {
            const cardIndex = state.g1_cards.findIndex(c => c.id === id);
            const card = state.g1_cards[cardIndex];

            if (!card || card.matched || card.flipped || state.g1_flipped.length === 2) {
                return;
            }

            card.flipped = true;
            state.g1_flipped.push(card);
            renderGame1(); 

            if (state.g1_flipped.length === 2) {
                const [card1, card2] = state.g1_flipped;
                const isMatch = card1.groupId === card2.groupId;
                
                if (isMatch) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g1_matchCount++;
                    
                    state.g1_flipped = []; 
                    renderGame1(); 
                    
                    // 檢查所有配對是否完成
                    if (state.g1_matchCount === NUM_GAME1_CARDS / 2) {
                        MessageBox.show("太棒了！所有恐龍蛋都配對成功了！🎉", false);
                        
                        // 整個遊戲集答對：將所有使用的單字從 missed 中移除
                        state.g1_currentQuestionItem.forEach(item => {
                             updatePools('game1', item, true, 'N/A');
                        });
                        
                        setTimeout(initGame1, 1500); // 進入下一輪
                    }
                } else {
                    // 答錯: 將當前遊戲集的所有項目加入 missed
                    state.g1_currentQuestionItem.forEach(item => {
                         updatePools('game1', item, false, 'N/A');
                    });
                    
                    setTimeout(() => {
                        const index1 = state.g1_cards.findIndex(c => c.id === card1.id);
                        const index2 = state.g1_cards.findIndex(c => c.id === card2.id);
                        
                        if (index1 !== -1) state.g1_cards[index1].flipped = false;
                        if (index2 !== -1) state.g1_cards[index2].flipped = false;
                        
                        state.g1_flipped = [];
                        renderGame1(); 
                    }, 1500); 
                }
            }
        }

        function renderGame1(wordError = false) {
             // ... rendering logic remains largely the same, but pool info should be displayed ...
             const container = document.getElementById('game-content');
            if (currentGame !== 'game1') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">遊戲無法開始：詞彙不足！請前往單字後台 (遊戲1) 新增。</p>`;
                return;
            }

            const cardsHtml = state.g1_cards.map(card => {
                const innerStyle = card.type === 'word' ? 'font-size: 1.5rem;' : 'font-size: 2.5rem;';

                return `
                    <div class="h-28 w-28 md:h-32 md:w-32 mx-auto perspective-[1000px]" onclick="handleCardClickG1('${card.id}')">
                        <div class="dino-card ${card.flipped || card.matched ? 'flipped' : ''} ${card.matched ? 'matched' : ''}" style="transition: transform 0.8s;">
                            <!-- 背面 (未翻開) -->
                            <div class="dino-card-inner dino-card-front text-4xl transform-gpu">
                                🥚
                            </div>
                            <!-- 正面 (內容) -->
                            <div class="dino-card-inner dino-card-back text-gray-800 transform-gpu" style="${innerStyle}">
                                ${card.value.toLowerCase()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">🦖 恐龍蛋詞彙配對 (Dino Egg Match)</h2>
                    <p class="text-center text-sm mb-2">目標: 點擊恐龍蛋，配對單字和圖片 (共 ${NUM_GAME1_CARDS / 2} 組)。</p>
                    <p class="text-center text-xs text-gray-700 mb-4">
                        新題庫: ${state.pools.game1.pool.length} | 錯題庫: ${state.pools.game1.missed.length}
                    </p>
                    <div id="dino-match-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-lg mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame1(true)" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            重新開始/下一輪
                        </button>
                    </div>
                </section>
            `;
        }
        // --- 遊戲 1 邏輯結束 ---

        // --- 遊戲 2 (機器人字母拼圖) 邏輯 ---
        function initGame2(isInit = false) {
            newQuestionG2(isInit);
        }

        function newQuestionG2(isInit = false) {
            const sourceWords = getWordList('game2');
            if (sourceWords.length === 0) {
                 MessageBox.show(`字母拼圖遊戲需要單字，請至後台 (遊戲2) 新增。`, true);
                 renderGame2(true);
                 return;
            }
            
            const itemObj = drawNextItem('game2');
            if (!itemObj) {
                // 如果 pool 和 missed 都空了，重新呼叫 initGame2 進行重設
                initGame2(true);
                return;
            }

            // 確保 word 屬性存在
            const randomWord = itemObj.item.word;
            
            state.g2_currentQuestionItem = itemObj.item; 

            state.g2_currentWord = randomWord.toUpperCase(); 
            
            const targetLetters = state.g2_currentWord.split('');
            state.g2_shuffledLetters = shuffleArray(targetLetters).map(l => ({ 
                id: crypto.randomUUID(), 
                value: l, 
                used: false 
            }));
            
            state.g2_targetLetters = targetLetters.map(l => ({ value: l, filled: null })); 
            state.g2_userLetters = Array(targetLetters.length).fill(null); 
            
            renderGame2();
        }
        
        // 拖曳事件處理 (簡化為點擊填空)
        function handleLetterClickG2(letterId) {
            const letterObj = state.g2_shuffledLetters.find(l => l.id === letterId);
            if (!letterObj || letterObj.used) return;
            
            const targetIndex = state.g2_userLetters.findIndex(l => l === null);

            if (targetIndex !== -1) {
                // 填充目標欄位
                state.g2_userLetters[targetIndex] = letterObj.value;
                letterObj.used = true;
                
                checkCompletionG2();
                renderGame2();
            }
        }
        
        function handleTargetClickG2(targetIndex) {
            const letterValue = state.g2_userLetters[targetIndex];
            if (!letterValue) return;

            // 釋放被使用的字母塊
            const usedLetterObj = state.g2_shuffledLetters.find(l => l.value === letterValue && l.used);
            if (usedLetterObj) {
                usedLetterObj.used = false;
            }

            state.g2_userLetters[targetIndex] = null;
            renderGame2();
        }

        function checkCompletionG2() {
            if (state.g2_userLetters.some(l => l === null)) return;
            
            const guessedWord = state.g2_userLetters.join('');
            const isCorrect = guessedWord === state.g2_currentWord;
            
            if (isCorrect) {
                MessageBox.show(`太棒了！機器人組裝成功：${state.g2_currentWord}！🎉`, false);
                updatePools('game2', state.g2_currentQuestionItem, true, 'N/A');
                setTimeout(newQuestionG2, 1500);
            } else {
                MessageBox.show("拼字錯誤，再試試看！", true);
                updatePools('game2', state.g2_currentQuestionItem, false, 'N/A');
            }
        }

        function renderGame2(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">遊戲無法開始：單字庫不足！請前往單字後台 (遊戲2) 新增。</p>`;
                return;
            }

            const targetHtml = state.g2_targetLetters.map((target, index) => {
                const letter = state.g2_userLetters[index];
                const isCorrect = letter === target.value;
                const displayClass = letter ? (isCorrect ? 'bg-green-300' : 'bg-red-300') : 'bg-white';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="robot-target w-12 h-12 md:w-16 md:h-16 ${letter ? 'filled' : ''} ${displayClass} text-2xl font-bold" onclick="handleTargetClickG2(${index})">
                            ${letter ? letter.toLowerCase() : '?'}
                        </div>
                        <p class="text-xs mt-1 text-gray-500">${index + 1}</p>
                    </div>
                `;
            }).join('');

            const shuffledHtml = state.g2_shuffledLetters.map(letter => {
                const buttonClass = letter.used ? 'opacity-30 cursor-not-allowed' : 'hover:bg-yellow-400';
                return `
                    <button class="robot-part text-2xl md:text-3xl ${buttonClass}" 
                            onclick="handleLetterClickG2('${letter.id}')"
                            ${letter.used ? 'disabled' : ''}>
                        ${letter.value.toLowerCase()}
                    </button>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">🤖 機器人字母拼圖 (Robot Letter Puzzle)</h2>
                    <p class="text-center text-sm mb-2">目標: 點擊下方的機器人部件 (字母)，依序填入正確位置，拼出單字。</p>
                    <p class="text-center text-xs text-gray-700 mb-4">
                        新題庫: ${state.pools.game2.pool.length} | 錯題庫: ${state.pools.game2.missed.length}
                    </p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <p class="text-3xl md:text-5xl mb-4 font-extrabold text-blue-800">
                        目標單字長度: ${state.g2_currentWord.length}
                    </p>
                    
                    <!-- 聽力按鈕 -->
                    <button onclick="callTTS(state.g2_currentWord)" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg mb-6">
                        🔊 點擊聆聽單字
                    </button>

                    <!-- 拼字目標區 -->
                    <div class="flex space-x-2 md:space-x-3 mb-8">
                        ${targetHtml}
                    </div>

                    <!-- 機器人部件 (字母塊) -->
                    <div class="flex flex-wrap justify-center gap-2 md:gap-3 p-4 bg-white rounded-lg shadow-inner border-4 border-gray-300">
                        ${shuffledHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="newQuestionG2(false)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            下一個單字
                        </button>
                    </div>
                </div>
            `;
        }
        // --- 遊戲 2 邏輯結束 ---
        
        // --- 遊戲 3 (超級英雄動作指令) 邏輯 ---
        function initGame3(isInit = false) {
            if(isInit) state.g3_score = 0;
            newActionG3();
        }

        function newActionG3() {
            const sourceActions = getWordList('game3');

            if (sourceActions.length < 3) {
                 MessageBox.show(`動作指令遊戲需要至少 3 個動作，請至後台 (遊戲3) 新增。`, true);
                 renderGame3(true);
                 return;
            }
            
            const itemObj = drawNextItem('game3');
            if (!itemObj) {
                initGame3(true);
                return;
            }
            
            const correctAnswer = itemObj.item; // 這是正確答案 (Item Object)
            state.g3_currentQuestionItem = correctAnswer; 

            // 隨機選擇另外兩個錯誤選項
            const otherActions = sourceActions.filter(a => getItemKey(a, 'game3') !== getItemKey(correctAnswer, 'game3'));
            const wrongAnswers = shuffleArray(otherActions).slice(0, 2);
            
            const allOptions = shuffleArray([correctAnswer, ...wrongAnswers]);

            state.g3_currentAction = {
                command: `${correctAnswer.verb.toUpperCase()}!`,
                correctVerb: correctAnswer.verb,
                options: allOptions
            };
            
            renderGame3();
            // 延遲播放指令
            setTimeout(() => callTTS(state.g3_currentAction.command), 500);
        }

        function handleGuessG3(guessedVerb) {
            if (state.g3_currentAction.isGuessed) return;
            
            state.g3_currentAction.isGuessed = true;
            const isCorrect = guessedVerb === state.g3_currentAction.correctVerb;
            
            if (isCorrect) {
                state.g3_score++;
                MessageBox.show("BINGO! 太棒了！💪", false);
                updatePools('game3', state.g3_currentQuestionItem, true, 'N/A');
                
                // 簡單的 CSS 動作動畫
                const heroElement = document.getElementById('superhero-hero');
                if (heroElement) {
                    heroElement.style.transform = 'translateY(-10px) scale(1.1)';
                    setTimeout(() => heroElement.style.transform = 'translateY(0) scale(1)', 500);
                }
            } else {
                state.g3_score = Math.max(0, state.g3_score - 1);
                MessageBox.show(`答錯了，指令是 ${state.g3_currentAction.command.toLowerCase()}。`, true);
                updatePools('game3', state.g3_currentQuestionItem, false, 'N/A');
            }
            
            renderGame3();
            
            // 進入下一輪
            setTimeout(newActionG3, 2000);
        }

        function renderGame3(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">遊戲無法開始：動作指令不足！請前往單字後台 (遊戲3) 新增至少 3 個動作。</p>`;
                return;
            }

            const optionsHtml = state.g3_currentAction?.options.map(option => `
                <button onclick="handleGuessG3('${option.verb}')" 
                        class="superhero-option flex flex-col items-center justify-center p-4 rounded-xl shadow-cute hover:bg-blue-300 transition duration-200"
                        ${state.g3_currentAction.isGuessed ? 'disabled' : ''}>
                    <span class="text-4xl md:text-5xl mb-2">${option.image}</span>
                    <span class="text-sm md:text-lg">${option.verb}</span>
                </button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">🦸 超級英雄動作指令 (Superhero Action)</h2>
                    <p class="text-center text-sm mb-2">目標: 點擊喇叭聆聽指令，然後點擊正確的動作圖示。</p>
                    <p class="text-center text-xs text-gray-700 mb-4">
                        新題庫: ${state.pools.game3.pool.length} | 錯題庫: ${state.pools.game3.missed.length}
                    </p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <div class="mb-4 flex justify-between w-full max-w-sm">
                        <p class="text-lg font-bold text-gray-700">得分: ${state.g3_score}</p>
                        <button onclick="newActionG3()" class="text-sm bg-accent-yellow px-3 py-1 rounded-full shadow-md hover:bg-yellow-400">
                            下一題
                        </button>
                    </div>

                    <!-- 英雄區 -->
                    <div id="superhero-hero" class="text-9xl mb-8 transition-transform duration-500 transform-gpu">
                        💥 
                    </div>

                    <!-- 喇叭和指令 -->
                    <button onclick="callTTS(state.g3_currentAction.command)" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto mb-6">
                        🔊 聆聽指令
                    </button>

                    <!-- 選項按鈕 -->
                    <div class="grid grid-cols-3 gap-4 max-w-md w-full">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }
        // --- 遊戲 3 邏輯結束 ---

        // --- 遊戲 4 (交通工具文法停車場) 邏輯 ---
        function initGame4(isInit = false) {
            state.g4_isLocked = false;
            newSentenceG4();
        }

        function newSentenceG4() {
            const sourceSentences = getWordList('game4');
            if (sourceSentences.length === 0) {
                 MessageBox.show(`文法停車場遊戲需要句型，請至後台 (遊戲4) 新增。`, true);
                 renderGame4(true);
                 return;
            }
            
            const itemObj = drawNextItem('game4');
            if (!itemObj) {
                initGame4(true);
                return;
            }
            
            const newSentence = itemObj.item; 
            state.g4_currentQuestionItem = newSentence; 

            state.g4_currentSentence = {
                ...newSentence,
                // 打亂選項的順序
                shuffledOptions: shuffleArray(newSentence.options),
                userAnswer: null
            };
            state.g4_isLocked = false;
            
            renderGame4();
        }
        
        function handleParkingG4(guessedOption) {
            if (state.g4_isLocked) return;

            state.g4_isLocked = true;
            state.g4_currentSentence.userAnswer = guessedOption;

            const isCorrect = guessedOption === state.g4_currentSentence.answer;
            
            renderGame4(); // 立即渲染以顯示答案和鎖定按鈕
            
            updatePools('game4', state.g4_currentQuestionItem, isCorrect, 'N/A');

            const carElement = document.getElementById('parking-car');
            const parkingSpots = document.querySelectorAll('.parking-spot');
            const correctIndex = state.g4_currentSentence.shuffledOptions.findIndex(opt => opt === state.g4_currentSentence.answer);
            const guessIndex = state.g4_currentSentence.shuffledOptions.findIndex(opt => opt === guessedOption);

            if (carElement) {
                if (isCorrect) {
                    MessageBox.show("停車成功！✅", false);
                } else {
                     // 錯誤時播放震動效果
                    carElement.classList.add('animate-pulse');
                    setTimeout(() => carElement.classList.remove('animate-pulse'), 500);
                    MessageBox.show(`答錯了，正確答案是 ${state.g4_currentSentence.answer.toLowerCase()}。`, true);
                }
            }
            
            // 延遲進入下一題
            setTimeout(newSentenceG4, 2500);
        }

        function renderGame4(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">遊戲無法開始：句型單字庫不足！請前往單字後台 (遊戲4) 新增。</p>`;
                return;
            }

            const sentenceWithBlank = state.g4_currentSentence.pattern.replace('____', 
                `<span class="text-red-600 font-extrabold p-1 bg-yellow-200 rounded">${state.g4_isLocked ? state.g4_currentSentence.userAnswer : '____'}</span>`
            );

            const optionsHtml = state.g4_currentSentence.shuffledOptions.map((option, index) => {
                const isCorrect = option === state.g4_currentSentence.answer;
                const isGuessed = state.g4_isLocked && option === state.g4_currentSentence.userAnswer;
                
                let spotClass = 'parking-spot hover:shadow-lg hover:scale-[1.02]';
                if (state.g4_isLocked) {
                    spotClass = isGuessed 
                        ? (isCorrect ? 'bg-green-300 border-green-600' : 'bg-red-300 border-red-600')
                        : (isCorrect ? 'bg-yellow-300 border-yellow-600' : 'bg-gray-200 border-gray-400');
                } else {
                     spotClass += ' bg-white';
                }

                return `
                    <div onclick="handleParkingG4('${option}')" 
                         class="text-xl font-bold text-gray-800 text-center ${spotClass} transition duration-300">
                        ${option}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-2 text-center">🚗 交通工具文法停車場 (Grammar Parking Lot)</h2>
                    <p class="text-center text-sm mb-2">目標: 選擇正確的單字/詞組，讓汽車停入正確的停車位。</p>
                    <p class="text-center text-xs text-gray-700 mb-4">
                        新題庫: ${state.pools.game4.pool.length} | 錯題庫: ${state.pools.game4.missed.length}
                    </p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    
                    <!-- 汽車圖示 -->
                    <div id="parking-car" class="text-6xl mb-4 transition-transform duration-500 car-anim">
                        🚗
                    </div>

                    <!-- 句子顯示區 -->
                    <div class="text-3xl md:text-4xl font-semibold mb-8 p-4 bg-white rounded-lg border-4 border-gray-300">
                        ${sentenceWithBlank.toLowerCase()}
                    </div>

                    <!-- 停車位選項 -->
                    <div class="grid grid-cols-3 gap-4 max-w-lg w-full">
                        ${optionsHtml}
                    </div>

                    <div class="text-center mt-6">
                        <button onclick="newSentenceG4()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg" ${state.g4_isLocked ? 'disabled' : ''}>
                            跳過 / 下一題
                        </button>
                    </div>
                </div>
            `;
        }
        // --- 遊戲 4 邏輯結束 ---

        // --- 遊戲 5 (誰說謊了?) 邏輯 ---
        function initGame5(isInit = false) {
            state.g5_gameStatus = 'ready';
            newQuestionG5();
        }

        function newQuestionG5() {
            const sourceQuestions = getWordList('game5');
            if (sourceQuestions.length === 0) {
                 MessageBox.show(`「誰說謊了？」遊戲需要問題，請至後台 (遊戲5) 新增。`, true);
                 renderGame5(true);
                 return;
            }
            
            const itemObj = drawNextItem('game5');
            if (!itemObj) {
                initGame5(true);
                return;
            }

            const randomQuestion = itemObj.item;
            state.g5_currentQuestionItem = randomQuestion; 
            
            state.g5_currentStatement = {
                ...randomQuestion,
                isGuessed: false
            };
            state.g5_shaker = { true: false, false: false };
            state.g5_gameStatus = 'playing';
            renderGame5();
            
            // 延遲播放指令
            setTimeout(() => callTTS(randomQuestion.statement), 500);
        }

        function handleGuessG5(guess) {
            if (state.g5_currentStatement.isGuessed) return;
            
            state.g5_currentStatement.isGuessed = true;
            const correctAnswer = state.g5_currentStatement.answer;
            const isCorrect = guess === correctAnswer;
            
            updatePools('game5', state.g5_currentQuestionItem, isCorrect, 'N/A');
            
            if (isCorrect) {
                MessageBox.show("答對了！這位人物說的是實話！🎉", false);
            } else {
                const lyingPerson = guess.toLowerCase(); // TRUE or FALSE
                state.g5_shaker[lyingPerson] = true;
                
                MessageBox.show("答錯了！這個人物在說謊！🤥", true);
            }
            
            renderGame5();
            setTimeout(newQuestionG5, 2500);
        }

        function renderGame5(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">遊戲無法開始：問題單字庫不足！請前往單字後台 (遊戲5) 新增。</p>`;
                return;
            }
            
            const statement = state.g5_currentStatement.statement.toLowerCase();
            const isGuessed = state.g5_currentStatement.isGuessed;

            // 判斷哪個角色是說謊者 (如果是 TRUE 答案，那麼說 FALSE 的就是說謊者)
            const trueIsLying = isGuessed && state.g5_currentStatement.answer === 'FALSE';
            const falseIsLying = isGuessed && state.g5_currentStatement.answer === 'TRUE';
            
            const trueShaker = state.g5_shaker.true ? 'shaking' : '';
            const falseShaker = state.g5_shaker.false ? 'shaking' : '';
            
            // 決定吐舌頭的顯示，只有在被點擊且答錯時顯示
            const showTrueTongue = state.g5_shaker.true;
            const showFalseTongue = state.g5_shaker.false;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">🤥 誰說謊了? (Who's Lying? - Reading)</h2>
                    <p class="text-center text-sm mb-2">目標: 閱讀短句並判斷真假 (True/False)。</p>
                    <p class="text-center text-xs text-gray-700 mb-4">
                        新題庫: ${state.pools.game5.pool.length} | 錯題庫: ${state.pools.game5.missed.length}
                    </p>
                </section>

                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md w-full">
                    
                    <div class="mb-6 p-4 md:p-6 bg-white rounded-xl shadow-lg border-4 border-accent-yellow w-full max-w-xl text-center">
                        <h3 class="text-2xl md:text-4xl font-extrabold text-gray-800">
                            "${statement}"
                        </h3>
                    </div>
                    
                    <button onclick="callTTS(state.g5_currentStatement.statement)" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg mb-8">
                        🔊 聆聽短句
                    </button>

                    <!-- 角色選項區 (True vs False) -->
                    <div class="flex justify-around items-end w-full max-w-3xl">
                        
                        <!-- 誠實騎士/小丑 (TRUE) -->
                        <div class="flex flex-col items-center relative p-2">
                            <div id="true-character" class="text-6xl md:text-8xl p-3 mb-2 transition-transform duration-300 relative ${trueShaker}">
                                ${trueIsLying ? '🤡' : '👑'}
                                ${showTrueTongue ? `<span class="tongue-container"><span class="tongue-out">👅</span></span>` : ''}
                            </div>
                            <button onclick="handleGuessG5('TRUE')" 
                                    class="text-2xl md:text-3xl font-extrabold py-3 px-8 rounded-2xl shadow-cute transition duration-150 
                                        ${trueIsLying ? 'bg-red-400 opacity-70 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500'}"
                                    ${isGuessed ? 'disabled' : ''}>
                                TRUE
                            </button>
                            ${isGuessed ? `<p class="text-lg font-bold mt-2 ${trueIsLying ? 'text-red-600' : 'text-green-600'}">${trueIsLying ? '說謊者' : '誠實者'}</p>` : ''}
                        </div>

                        <!-- 狡猾小丑/騎士 (FALSE) -->
                        <div class="flex flex-col items-center relative p-2">
                            <div id="false-character" class="text-6xl md:text-8xl p-3 mb-2 transition-transform duration-300 relative ${falseShaker}">
                                ${falseIsLying ? '🤡' : '👑'}
                                ${showFalseTongue ? `<span class="tongue-container"><span class="tongue-out">👅</span></span>` : ''}
                            </div>
                            <button onclick="handleGuessG5('FALSE')" 
                                    class="text-2xl md:text-3xl font-extrabold py-3 px-8 rounded-2xl shadow-cute transition duration-150 
                                        ${falseIsLying ? 'bg-red-400 opacity-70 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500'}"
                                    ${isGuessed ? 'disabled' : ''}>
                                FALSE
                            </button>
                            ${isGuessed ? `<p class="text-lg font-bold mt-2 ${falseIsLying ? 'text-red-600' : 'text-green-600'}">${falseIsLying ? '說謊者' : '誠實者'}</p>` : ''}
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button onclick="newQuestionG5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            下一個問題
                        </button>
                    </div>
                </div>
            `;
        }


        // --- 單字管理後台 邏輯 ---
        function changeAdminTarget(gameKey) {
            state.admin_currentGameKey = gameKey;
            renderWordAdmin();
        }

        function addWord() {
            const input1 = document.getElementById('new-word-input-1');
            const input2 = document.getElementById('new-word-input-2');
            const gameKey = state.admin_currentGameKey;
            const wordList = localCustomWords[gameKey];

            const rawValue1 = input1.value.trim();
            const rawValue2 = input2.value.trim(); 
            
            let entriesToAdd = [];
            let errorCount = 0;
            let successMessage = "";

            if (gameKey === 'game2') {
                // 遊戲 2: 每行一個單字
                const lines = rawValue1.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                lines.forEach(line => {
                    const word = line.toUpperCase();
                    if (/^[A-Z\s]+$/.test(word)) {
                        entriesToAdd.push({ id: crypto.randomUUID(), word: word });
                    } else {
                        errorCount++;
                    }
                });

            } else if (gameKey === 'game4') {
                // 遊戲 4 (特殊處理): 欄位 1: 選項 (逗號分隔), 欄位 2: 句型 (單獨處理)
                const optionsArray = rawValue1.split(',').map(o => o.trim().toUpperCase()).filter(o => o.length > 0);
                const pattern = rawValue2.split('\n')[0].trim(); 
                
                if (!pattern.includes('____') || optionsArray.length < 2) { 
                    MessageBox.show("句型必須包含 '____' 且選項至少兩個。", true); 
                    return; 
                }
                
                const answer = optionsArray[0]; 
                
                entriesToAdd.push({ id: crypto.randomUUID(), pattern: pattern.toUpperCase(), options: optionsArray, answer: answer });

            } else {
                // 遊戲 1, 3, 5: 欄位 1 (主值) 與 欄位 2 (配對值) 按行配對
                const lines1 = rawValue1.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const lines2 = rawValue2.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                const count = Math.min(lines1.length, lines2.length);

                if (lines1.length !== lines2.length && count > 0) {
                     // 處理行數不匹配的錯誤，但仍處理匹配的行
                     errorCount += Math.abs(lines1.length - lines2.length);
                     successMessage += `(注意: 欄位行數不匹配，僅處理了 ${count} 組) `;
                } else if (count === 0) {
                    MessageBox.show("沒有偵測到有效輸入。", true);
                    return;
                }
                
                for (let i = 0; i < count; i++) {
                    const value1 = lines1[i]; // 主值 (Word/Verb/Statement)
                    const value2 = lines2[i]; // 配對值 (Image/Emoji/Answer)

                    let newEntry = null;

                    if (gameKey === 'game1') { // Dino Egg: {word, image}
                        if (/^[A-Z\s]+$/.test(value1.toUpperCase()) && value2.length > 0) {
                            newEntry = { id: crypto.randomUUID(), word: value1.toUpperCase(), image: value2 };
                        } else { errorCount++; }
                    } else if (gameKey === 'game3') { // Superhero Action: {verb, image}
                         if (/^[A-Z\s]+$/.test(value1.toUpperCase()) && value2.length > 0) {
                             newEntry = { id: crypto.randomUUID(), verb: value1.toUpperCase(), image: value2 };
                        } else { errorCount++; }
                    } else if (gameKey === 'game5') { // Who's Lying?: {statement, answer}
                         const g5_answer = value2.toUpperCase();
                         if ((g5_answer === 'TRUE' || g5_answer === 'FALSE') && value1.length > 0) {
                             newEntry = { id: crypto.randomUUID(), statement: value1, answer: g5_answer };
                        } else { errorCount++; }
                    }

                    if (newEntry) {
                         entriesToAdd.push(newEntry);
                    } else {
                        errorCount++;
                    }
                }
            }


            // 最終儲存
            let addedCount = 0;
            entriesToAdd.forEach(newEntry => {
                // 檢查是否重複
                const isDuplicate = wordList.some(item => {
                    if (gameKey === 'game4') return item.pattern === newEntry.pattern;
                    if (gameKey === 'game5') return item.statement === newEntry.statement;
                    if (gameKey === 'game3') return item.verb === newEntry.verb;
                    return item.word === newEntry.word;
                });

                if (!isDuplicate) {
                    wordList.push(newEntry);
                    addedCount++;
                }
            });


            // 反饋
            saveWordsToLocal();
            input1.value = '';
            input2.value = ''; 

            if (addedCount > 0) {
                let finalMessage = `成功新增 ${addedCount} 個項目。` + successMessage;
                if (errorCount > 0) {
                    finalMessage += ` (有 ${errorCount} 個項目格式不正確或被忽略)`;
                }
                MessageBox.show(finalMessage, false);
            } else if (errorCount > 0) {
                MessageBox.show(`所有項目皆新增失敗或格式不正確。請檢查輸入。`, true);
            } else {
                MessageBox.show("沒有新增任何項目 (可能所有輸入都重複或為空)。", true);
            }

            renderWordAdmin();
        }

        function deleteWord(id) {
            const gameKey = state.admin_currentGameKey;
            
            const initialLength = localCustomWords[gameKey].length;
            localCustomWords[gameKey] = localCustomWords[gameKey].filter(item => item.id !== id);

            if (localCustomWords[gameKey].length < initialLength) {
                saveWordsToLocal();
                MessageBox.show("項目刪除成功！", false);
            } else {
                 MessageBox.show("項目刪除失敗，找不到該 ID。", true);
            }
            
            renderWordAdmin();
        }

        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;
            
            const gameKey = state.admin_currentGameKey;
            const currentList = localCustomWords[gameKey] || [];
            
            const config = {
                game1: { title: 'Dino Egg Match (詞彙/圖片)', input1: '詞彙 (e.g., DINOSAUR)', input2: '圖片/Emoji (e.g., 🦖)', renderer: (item) => `${item.word} / ${item.image}` },
                game2: { title: 'Robot Puzzle (拼寫單字)', input1: '單字 (e.g., ROBOT)', input2: 'N/A', renderer: (item) => `${item.word}` },
                game3: { title: 'Superhero Action (動作/圖示)', input1: '動作 (e.g., JUMP)', input2: '圖示/Emoji (e.g., ⬆️)', renderer: (item) => `${item.verb} / ${item.image}` },
                game4: { title: 'Grammar Parking Lot (句型/選項)', input1: '選項 (逗號分隔, 第一個為答案 e.g., IS, AM, ARE)', input2: '句型 (必須包含 ____ e.g., HE ____ MY FRIEND)', renderer: (item) => `${item.pattern.replace('____', `(${item.answer})`)} | Options: ${item.options.join(', ')}` },
                game5: { title: 'Who\'s Lying? (事實/判斷)', input1: '事實短句 (e.g., The sky is red.)', input2: '正確答案 (TRUE/FALSE)', renderer: (item) => `[${item.answer}] ${item.statement}` },
            };
            
            const currentConfig = config[gameKey];
            
            // 獲取當前單字列表
            const wordListHtml = currentList.map((item, index) => `
                <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                    <span class="text-lg font-bold text-gray-800">${index + 1}. ${currentConfig.renderer(item)}</span>
                    <button onclick="deleteWord('${item.id}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                        🗑️ 刪除
                    </button>
                </li>
            `).join('');

            // --- 輸入框渲染邏輯 ---
            const isSingleInput = currentConfig.input2 === 'N/A'; // Game 2
            
            const inputHelpText = isSingleInput
                ? `請在下方輸入區輸入，每行一個單字。`
                : gameKey === 'game4'
                    ? `【欄位 1】輸入所有選項 (逗號分隔)，【欄位 2】輸入帶有 '____' 的句型。建議一次只新增一組，以確保資料正確。`
                    : `請在兩個欄位中輸入內容，並確保它們是「按行」對齊的，系統會將第 N 行的欄位 1 和欄位 2 視為一組。`;

            const input1Placeholder = isSingleInput
                ? currentConfig.input1 + ' (每行一個)'
                : currentConfig.input1;


            const inputHtml = `
                <div class="space-y-3 mb-4">
                    <p class="text-sm text-gray-600 mb-2">${inputHelpText}</p>

                    <div class="flex ${isSingleInput ? '' : 'space-x-4'}">
                        <!-- 欄位 1 -->
                        <div class="${isSingleInput ? 'w-full' : 'w-1/2'}">
                            <label for="new-word-input-1" class="block text-sm font-semibold text-gray-800">欄位 1: ${currentConfig.input1}</label>
                            <textarea id="new-word-input-1" placeholder="${input1Placeholder}" rows="5"
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue ${gameKey === 'game2' ? 'uppercase' : ''}"></textarea>
                        </div>
                        
                        <!-- 欄位 2 (只有配對遊戲顯示) -->
                        ${!isSingleInput ? 
                            `<div class="w-1/2">
                                <label for="new-word-input-2" class="block text-sm font-semibold text-gray-800">欄位 2: ${currentConfig.input2}</label>
                                <textarea id="new-word-input-2" placeholder="${currentConfig.input2}" rows="5"
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue ${gameKey === 'game4' ? 'uppercase' : ''}"></textarea>
                             </div>`
                            : `<input type="hidden" id="new-word-input-2" value="">`}
                    </div>
                </div>
            `;
            // --- 結束輸入框渲染邏輯 ---


            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">⚙️ 單字管理後台 (統一控制面板)</h2>
                    <p class="text-center text-pink-100">💡 這裡的單字僅儲存在您當前的瀏覽器中，並供對應的遊戲使用。</p>
                </section>
                
                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md border-b-4 border-accent-yellow">
                    <label for="game-selector" class="block text-lg font-semibold text-gray-800 mb-2">選擇要管理的遊戲單字庫</label>
                    <select id="game-selector" onchange="changeAdminTarget(this.value)" 
                            class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white text-xl font-bold focus:ring-secondary-blue focus:border-secondary-blue mb-4">
                        ${Object.keys(config).map(key => `<option value="${key}" ${gameKey === key ? 'selected' : ''}>${config[key].title}</option>`).join('')}
                    </select>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-4">新增項目到 **${currentConfig.title}**</h3>
                    
                    ${inputHtml}

                    <button onclick="addWord()" class="w-full bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150">
                        ➕ 批量新增
                    </button>
                    
                    ${gameKey === 'game1' && currentList.length < 4 ? `<p class="text-red-500 mt-2">❗ 恐龍蛋遊戲需要至少 4 組配對才能開始。</p>` : ''}
                    ${gameKey === 'game2' && currentList.length === 0 ? `<p class="text-red-500 mt-2">❗ 字母拼圖遊戲需要單字才能開始。</p>` : ''}
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        ${currentConfig.title} 自訂列表 (${currentList.length} 個)
                    </h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">目前沒有自訂項目。如果列表為空，遊戲將使用內建項目。</p>'}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>
