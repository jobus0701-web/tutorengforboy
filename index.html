<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡éŠæˆ²æ¨‚åœ’ï¼šå®Œæ•´ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* å®šç¾©å¯æ„›çš„å¡é€šå­—é«”ï¼Œä½¿ç”¨ Inter æ­é…åœ“è§’å’Œç²—é«”ç‡Ÿé€ ç«¥è¶£æ„Ÿ */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* æ¸¸æ¨™é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .key-btn {
            height: 50px; /* Base height */
            transition: all 0.1s;
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }

        /* éŠæˆ² 1: æé¾è›‹å¡ç‰‡æ¨£å¼ */
        .dino-card {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* è›‹å½¢æŒ‰éˆ• */
            border: 4px solid #F0B5C2;
            background-color: #FFEC99;
            cursor: pointer;
            transition: all 0.5s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .dino-card.flipped {
            transform: rotateY(180deg);
        }
        .dino-card-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .dino-card-front {
            background-color: #BDE0FE; /* è›‹æ®¼è— */
            color: #1E40AF;
        }
        .dino-card-back {
            background-color: #F8F8F8; /* å…§å®¹ç™½ */
            color: #333;
            transform: rotateY(180deg);
            padding: 5px;
        }
        .dino-card.matched {
            background-color: #90EE90;
            border-color: #3CB371;
            cursor: default;
        }
        /* åœ–ç‰‡/Emoji è‡ªé©æ‡‰å¤§å° */
        .dino-card-back .emoji-content {
            font-size: 3rem;
        }

        /* éŠæˆ² 2: æ©Ÿå™¨äººå­—æ¯æ‹¼åœ–æ¨£å¼ */
        .robot-target {
            min-height: 50px;
            width: 50px;
            border: 3px dashed #7B68EE;
            background-color: #E6E6FA;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .robot-part {
            background-color: #FFD700; /* é‡‘å±¬é»ƒ */
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: grab;
            box-shadow: 0 4px 0 0 #B8860B;
            transition: all 0.1s;
        }
        
        /* éŠæˆ² 3: è¶…ç´šè‹±é›„å‹•ä½œæ¨£å¼ */
        .superhero-option {
            background-color: #BDE0FE;
            color: #1E40AF;
            font-weight: bold;
            box-shadow: 0 4px 0 0 #87CEEB;
            /* è®“æŒ‰éˆ•å…§å®¹å±…ä¸­ä¸¦èª¿æ•´ç‚ºæ–‡å­—/Emojiå°ºå¯¸ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* ç¢ºä¿æœ‰è¶³å¤ ç©ºé–“é¡¯ç¤º */
        }
        .superhero-option .verb-display {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* éŠæˆ² 4: æ–‡æ³•åœè»Šå ´æ¨£å¼ */
        .parking-spot {
            background-color: #F0F8FF;
            border: 2px solid #ADD8E6;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 0 0 #87CEEB;
        }
        
        /* éŠæˆ² 5: èª°èªªè¬Šäº†? æ¨£å¼ */
        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) scale(1.02); }
            20%, 40%, 60%, 80% { transform: translateX(5px) scale(1.02); }
        }
        .shaking {
            animation: shake 0.5s ease-in-out;
        }
        .tongue-container {
             position: absolute;
             bottom: 0px;
             left: 50%;
             transform: translateX(-50%);
             z-index: 10;
        }
        .tongue-out {
             display: inline-block;
             animation: tongue 0.5s forwards;
             color: #FF4500;
             font-size: 2rem;
        }

        /* éŠæˆ² 6: ä»‹ç³»è©å°‹å¯¶æ¨£å¼ */
        .city-map {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background-color: #F0F0F0;
            padding: 20px;
            border-radius: 12px;
        }
        .location-spot {
            height: 100px;
            background-color: #fff;
            border: 3px solid #7B68EE;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 3rem;
            transition: all 0.2s;
        }
        .location-spot img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 4px;
        }
        .location-spot .content {
            font-size: 2rem;
        }

        /* éŠæˆ² 7: æ¯”è¼ƒç´šå‚³é€é–€æ¨£å¼ */
        .portal-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 5rem;
            position: relative;
        }
        /* ç§»é™¤ .concept æ¨£å¼ */
        .portal-item img {
            max-width: 100%; /* åœ–ç‰‡å¡«æ»¿ */
            max-height: 100%;
            object-fit: contain;
            margin-bottom: 0;
            border-radius: 12px;
            min-height: 150px;
        }
        .portal-button {
            background-color: #BDE0FE;
            color: #1E40AF;
            font-weight: bold;
            box-shadow: 0 4px 0 0 #87CEEB;
        }
        .portal-button.correct {
            background-color: #90EE90;
            box-shadow: 0 4px 0 0 #3CB371;
            animation: pulse 0.8s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>

    <script>
        // --- æ ¸å¿ƒå…¨åŸŸè®Šæ•¸ ---
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split(''); 
        const BASE_STORAGE_KEY = 'G_CustomWords_Unified_V2_'; // åŸºç¤å„²å­˜éµ
        const G4_BINGO_SIZE = 4;
        
        let currentGame = 'game1'; // éŠæˆ²å•Ÿå‹•æ™‚çš„ç•¶å‰éŠæˆ²
        let playerName = ''; // ç•¶å‰ç©å®¶åç¨±
        let isGeneratingImage = false; 

        // æ ¹æ“šç©å®¶åç¨±ç”Ÿæˆå”¯ä¸€çš„ localStorage key
        function getLocalStorageKey() {
            // æ¸…ç†ç©å®¶åç¨±ï¼Œç¢ºä¿ key æœ‰æ•ˆä¸”ä¸åŒ…å«ç‰¹æ®Šå­—å…ƒ
            const cleanedName = playerName.toUpperCase().replace(/[^A-Z0-9]/g, '_');
            return BASE_STORAGE_KEY + (cleanedName || 'GUEST');
        }
        
        // æœ€å°é …ç›®è¦æ±‚åœ°åœ–
        const MIN_REQUIRED_MAP = {
            game1: 4, // 4 pairs for matching (4 unique items in the source list)
            game2: 1, 
            game3: 3, // At least 3 options
            game4: 1, 
            game5: 1,
            game6: 1,
            game7: 1
        };

        // å…§å»ºå–®å­—åº« (ç”¨æ–¼ fallback)
        const DICTIONARY_MAP = {
            game1: [ // Dino Egg Match: Word/Emoji pairs
                { id: crypto.randomUUID(), word: "T-REX", emoji: "ğŸ¦–" }, 
                { id: crypto.randomUUID(), word: "EGG", emoji: "ğŸ¥š" },
                { id: crypto.randomUUID(), word: "CAR", emoji: "ğŸš—" },
                { id: crypto.randomUUID(), word: "SUN", emoji: "â˜€ï¸" },
                // ADDED ITEMS from user files
                { id: crypto.randomUUID(), word: "WATER", emoji: "ğŸ’§" }, 
                { id: crypto.randomUUID(), word: "COLD", emoji: "â„ï¸" },
                { id: crypto.randomUUID(), word: "BIRD", emoji: "ğŸ¦" },
                { id: crypto.randomUUID(), word: "FALL", emoji: "ğŸ" }
            ],
            game2: [ // Robot Letter Puzzle: Simple Spelling
                { id: crypto.randomUUID(), word: "ROBOT" }, { id: crypto.randomUUID(), word: "BIKE" },
                // ADDED ITEMS from user files
                { id: crypto.randomUUID(), word: "BLUE" }, { id: crypto.randomUUID(), word: "LIVE" },
                { id: crypto.randomUUID(), word: "KNOW" }, { id: crypto.randomUUID(), word: "VERY" },
                { id: crypto.randomUUID(), word: "WATCH" }, { id: crypto.randomUUID(), word: "WALK" }
            ],
            game3: [ // Superhero Action: Action Verbs (åªä¿ç•™ Verb)
                { id: crypto.randomUUID(), verb: "JUMP" }, 
                { id: crypto.randomUUID(), verb: "RUN" },
                { id: crypto.randomUUID(), verb: "CLAP" },
                // ADDED ITEMS from user files
                { id: crypto.randomUUID(), verb: "WASH" }, 
                { id: crypto.randomUUID(), verb: "SING" },
                { id: crypto.randomUUID(), verb: "SKIP" },
                { id: crypto.randomUUID(), verb: "GROW" }
            ],
            game4: [ // Grammar Parking Lot: Simple Sentences
                { id: crypto.randomUUID(), pattern: "I ____ HAPPY.", options: ["AM", "IS", "ARE"], answer: "AM" },
                { id: crypto.randomUUID(), pattern: "HE ____ SAD.", options: ["AM", "IS", "ARE"], answer: "IS" }
            ],
            game5: [ // Who's Lying? (Statement, Answer)
                { id: crypto.randomUUID(), statement: "A cat has four legs.", answer: "TRUE" },
                { id: crypto.randomUUID(), statement: "The sun is green.", answer: "FALSE" },
                // ADDED ITEMS from user files
                { id: crypto.randomUUID(), statement: "Animals need shelter.", answer: "TRUE" },
                { id: crypto.randomUUID(), statement: "All plants have flowers and fruits.", answer: "FALSE" },
                { id: crypto.randomUUID(), statement: "Salt water is found in the ocean.", answer: "TRUE" }
            ],
            game6: [ // Preposition Hunt: (Instruction, KeyImage, LocAImage, LocBImage, AnswerKey)
                { id: crypto.randomUUID(), instruction: "The key is next to the house.", keyImage: "ğŸ”‘", imageA: "ğŸ ", imageB: "ğŸŒ³", answerKey: "ğŸ”‘", urlKey: "", urlA: "", urlB: "" },
                // ADDED ITEM from user files
                { id: crypto.randomUUID(), instruction: "The hospital is next to the fire station.", keyImage: "HOSPITAL", imageA: "FIRE STATION", imageB: "POLICE STATION", answerKey: "HOSPITAL", urlKey: "ğŸ¥", urlA: "ğŸš’", urlB: "ğŸš“" }
            ],
            game7: [ // Comparative Portal: (Noun, Adj, Comparative, urlA, urlB)
                { id: crypto.randomUUID(), noun: "SNAKE", adj: "LONG", comparative: "LONGER", urlA: "https://placehold.co/100x150/FFEC99/333?text=SNAKE_A", urlB: "https://placehold.co/150x150/FFEC99/333?text=SNAKE_B" },
                 // ADDED ITEMS from user files
                { id: crypto.randomUUID(), noun: "UMBRELLA", adj: "GOOD", comparative: "BETTER", urlA: "https://placehold.co/100x150/BDE0FE/333?text=UMBRELLA_OLD", urlB: "https://placehold.co/150x150/BDE0FE/333?text=UMBRELLA_NEW" },
                { id: crypto.randomUUID(), noun: "BUILDING", adj: "TALL", comparative: "TALLER", urlA: "https://placehold.co/100x150/FFC7C7/333?text=BUILDING_SHORT", urlB: "https://placehold.co/150x150/FFC7C7/333?text=BUILDING_TALL" },
                { id: crypto.randomUUID(), noun: "HAT", adj: "NEW", comparative: "NEWER", urlA: "https://placehold.co/100x150/90EE90/333?text=HAT_OLD", urlB: "https://placehold.co/150x150/90EE90/333?text=HAT_NEW" }
            ]
        };

        const NUM_GAME1_CARDS = 8; // 4 pairs

        let localCustomWords = {}; // å„²å­˜å¾ localStorage è¼‰å…¥çš„è‡ªè¨‚å–®å­—

        let state = {
            // Pool Management
            pools: {
                game1: { pool: [], missed: [] },
                game2: { pool: [], missed: [] },
                game3: { pool: [], missed: [] },
                game4: { pool: [], missed: [] },
                game5: { pool: [], missed: [] },
                game6: { pool: [], missed: [] },
                game7: { pool: [], missed: [] },
            },
            // Game 1 (Dino Egg)
            g1_cards: [],
            g1_flipped: [],
            g1_matchCount: 0,
            g1_currentQuestionItem: null, 
            // Game 2 (Robot Puzzle)
            g2_currentWord: '',
            g2_shuffledLetters: [],
            g2_userLetters: [], 
            g2_targetLetters: [], 
            g2_currentQuestionItem: null,
            // Game 3 (Superhero Action)
            g3_currentAction: null, 
            g3_score: 0,
            g3_currentQuestionItem: null,
            // Game 4 (Parking Lot)
            g4_currentSentence: null,
            g4_isLocked: false,
            g4_currentQuestionItem: null,
            // Game 5 (Who's Lying?)
            g5_currentStatement: null,
            g5_gameStatus: 'ready',
            g5_shaker: { true: false, false: false }, 
            g5_currentQuestionItem: null,
            // Game 6 (Preposition Hunt)
            g6_currentQuestion: null,
            g6_isLocked: false,
            g6_score: 0,
            // Game 7 (Comparative Portal)
            g7_currentQuestion: null,
            g7_isLocked: false,
            g7_score: 0,
            // Admin
            admin_currentGameKey: 'game1' 
        };


        // --- TTS & Utility Functions ---
        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                MessageBox.show("ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³æ’­æ”¾åŠŸèƒ½ã€‚", true);
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => { console.error("SpeechSynthesis error:", e); resolve(); };
                window.speechSynthesis.speak(utterance);
            });
        }

        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        // --- LocalStorage Logic ---
        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(getLocalStorageKey());
                const loadedData = stored ? JSON.parse(stored) : {};
                
                // Initialize localCustomWords with default values or loaded data
                for (const key in DICTIONARY_MAP) {
                    // å¦‚æœè®€å–åˆ°çš„è³‡æ–™ç‚ºç©ºæˆ–éé™£åˆ—ï¼Œå‰‡ä½¿ç”¨é è¨­å€¼
                    localCustomWords[key] = Array.isArray(loadedData[key]) ? loadedData[key] : DICTIONARY_MAP[key];
                }
            } catch (e) {
                console.error("Error loading words from local storage:", e);
                localCustomWords = DICTIONARY_MAP; // Fallback to default
            }
        }

        function saveWordsToLocal() {
            try {
                let dataToSave = {};
                for (const key in localCustomWords) {
                    dataToSave[key] = localCustomWords[key];
                }
                localStorage.setItem(getLocalStorageKey(), JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("ç„¡æ³•ä¿å­˜å–®å­—åˆ°æ‚¨çš„ç€è¦½å™¨ã€‚", true);
            }
        }
        
        function getWordList(gameKey) {
            const custom = localCustomWords[gameKey];
            return (Array.isArray(custom) && custom.length > 0) ? custom : DICTIONARY_MAP[gameKey];
        }

        function getItemKey(item, gameKey) {
            if (gameKey === 'game1') return item.word.toUpperCase();
            if (gameKey === 'game2') return item.word.toUpperCase();
            if (gameKey === 'game3') return item.verb.toUpperCase();
            if (gameKey === 'game4') return item.pattern.toUpperCase();
            if (gameKey === 'game5') return item.statement; 
            if (gameKey === 'game6') return item.instruction; 
            if (gameKey === 'game7') return `${item.noun.toUpperCase()}_${item.adj.toUpperCase()}`;
            return null;
        }

        function drawNextItem(gameKey) {
             const pools = state.pools[gameKey];
            const sourceList = getWordList(gameKey);

            if (sourceList.length === 0) return null;

            if (pools.pool.length === 0 && pools.missed.length === 0) {
                pools.pool = [...sourceList];
                pools.missed = [];
                MessageBox.show(`[${gameKey}] å·²é–‹å§‹æ–°ä¸€è¼ªå–®å­—å­¸ç¿’ï¼`, false);
            }

            let item = null;
            let source = '';

            if (pools.missed.length > 0) {
                const index = Math.floor(Math.random() * pools.missed.length);
                item = pools.missed[index];
                source = 'missed';
            } else if (pools.pool.length > 0) {
                const index = Math.floor(Math.random() * pools.pool.length);
                item = pools.pool.splice(index, 1)[0];
                source = 'pool';
            }
            
            return item ? { item, source } : null;
        }

        function updatePools(gameKey, item, isCorrect) {
            const pools = state.pools[gameKey];
            const itemKey = getItemKey(item, gameKey);

            if (isCorrect) {
                for (let i = pools.missed.length - 1; i >= 0; i--) {
                    if (getItemKey(pools.missed[i], gameKey) === itemKey) {
                        pools.missed.splice(i, 1);
                        break;
                    }
                }
            } else {
                let alreadyMissed = pools.missed.some(missedItem => getItemKey(missedItem, gameKey) === itemKey);
                if (!alreadyMissed) {
                    pools.missed.push(item);
                }
            }
        }
        
        // --- Core App Control ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.getElementById(`tab-${gameName}`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); 
            // æ›´æ–°æ¨™é¡Œé¡¯ç¤ºç©å®¶åç¨±
            const titleElement = document.getElementById('main-title');
            if (titleElement) {
                 titleElement.textContent = `è‹±æ–‡éŠæˆ²æ¨‚åœ’ - ç©å®¶: ${playerName}`;
            }

            switch (currentGame) {
                case 'game1': initGame1(true); break;
                case 'game2': initGame2(true); break;
                case 'game3': initGame3(true); break;
                case 'game4': initGame4(true); break;
                case 'game5': initGame5(true); break;
                case 'game6': initGame6(true); break;
                case 'game7': initGame7(true); break;
                case 'admin': renderWordAdmin(); break;
                default: document.getElementById('game-content').innerHTML = `<p class="text-xl text-gray-500 text-center p-10">è«‹é¸æ“‡ä¸€å€‹éŠæˆ²</p>`;
            }
        }

        window.onload = function() {
            // 1. å½ˆå‡ºæç¤ºæ¡†ç²å–ç©å®¶åç¨±
            let name = prompt("è«‹è¼¸å…¥ç©å®¶åç¨± (ä¾‹å¦‚: brain æˆ– ivy) ä»¥è¼‰å…¥å€‹äººåŒ–è©å½™åº«ï¼š");
            if (name) {
                playerName = name.trim();
            } else {
                playerName = 'GUEST'; // é è¨­è¨ªå®¢åç¨±
            }
            
            // 2. æ‡‰ç”¨ç¨‹å¼å…¶é¤˜åˆå§‹åŒ–
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('bg-white', 'hover:bg-secondary-blue', 'py-2', 'px-3', 'md:px-4', 'rounded-full', 'text-xs', 'md:text-sm', 'font-bold', 'text-gray-700', 'transition', 'duration-300', 'shadow-md');
            });
            setTabActive(currentGame);
            renderApp();
        }
        
        // --- Game 1 (Dino Egg Match) Logic ---
        function initGame1(isInit = false) {
            const requiredPairs = NUM_GAME1_CARDS / 2;
            const sourceList = getWordList('game1');

            if (sourceList.length < requiredPairs) {
                 renderGame1(true); return;
            }
            
            let selectedPairs = shuffleArray(sourceList).slice(0, requiredPairs);
            
            selectedPairs.forEach(pair => {
                const key = getItemKey(pair, 'game1');
                const poolIndex = state.pools.game1.pool.findIndex(p => getItemKey(p, 'game1') === key);
                if (poolIndex !== -1) {
                    state.pools.game1.pool.splice(poolIndex, 1);
                }
            });

            state.g1_cards = [];
            state.g1_flipped = [];
            state.g1_matchCount = 0;
            state.g1_currentQuestionItem = selectedPairs;
            
            let cardValues = []; 
            selectedPairs.forEach((pair, index) => {
                const groupId = `match-${index}`; 
                // Card 1: Emoji (Image/Emoji Side)
                cardValues.push({ id: crypto.randomUUID(), value: pair.emoji, display: pair.emoji, type: 'emoji', groupId, matched: false, flipped: false, key: getItemKey(pair, 'game1') });
                // Card 2: Word (Word Side)
                cardValues.push({ id: crypto.randomUUID(), value: pair.word.toUpperCase(), display: pair.word.toUpperCase(), type: 'word', groupId, matched: false, flipped: false, key: getItemKey(pair, 'game1') });
            });
            
            state.g1_cards = shuffleArray(cardValues);
            renderGame1();
        }

        function handleCardClickG1(id) {
            const cardIndex = state.g1_cards.findIndex(c => c.id === id);
            const card = state.g1_cards[cardIndex];

            if (!card || card.matched || card.flipped || state.g1_flipped.length === 2) return;

            card.flipped = true;
            state.g1_flipped.push(card);
            renderGame1(); 

            if (state.g1_flipped.length === 2) {
                const [card1, card2] = state.g1_flipped;
                const isMatch = card1.groupId === card2.groupId;
                
                if (isMatch) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g1_matchCount++;
                    state.g1_flipped = []; 
                    renderGame1(); 
                    
                    if (state.g1_matchCount === NUM_GAME1_CARDS / 2) {
                        MessageBox.show("å¤ªæ£’äº†ï¼æ‰€æœ‰æé¾è›‹éƒ½é…å°æˆåŠŸäº†ï¼ğŸ‰", false);
                        state.g1_currentQuestionItem.forEach(item => updatePools('game1', item, true));
                        setTimeout(initGame1, 1500); 
                    }
                } else {
                    state.g1_currentQuestionItem.forEach(item => updatePools('game1', item, false));
                    setTimeout(() => {
                        const index1 = state.g1_cards.findIndex(c => c.id === card1.id);
                        const index2 = state.g1_cards.findIndex(c => c.id === card2.id);
                        if (index1 !== -1) state.g1_cards[index1].flipped = false;
                        if (index2 !== -1) state.g1_cards[index2].flipped = false;
                        state.g1_flipped = [];
                        renderGame1(); 
                    }, 1500); 
                }
            }
        }

        function renderGame1(wordError = false) {
             const container = document.getElementById('game-content');
            if (!container) return; // FIX: Added defensive check
            if (currentGame !== 'game1') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šè©å½™ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 1) æ–°å¢è‡³å°‘ 4 çµ„é…å°ã€‚</p>`;
                return;
            }

            const cardsHtml = state.g1_cards.map(card => {
                const innerContent = card.type === 'emoji' 
                    ? `<span class="emoji-content">${card.value}</span>`
                    : `<span class="text-xl">${card.value.toLowerCase()}</span>`;

                return `
                    <div class="h-28 w-28 md:h-32 md:w-32 mx-auto perspective-[1000px]" onclick="handleCardClickG1('${card.id}')">
                        <div class="dino-card ${card.flipped || card.matched ? 'flipped' : ''} ${card.matched ? 'matched' : ''}" style="transition: transform 0.8s;">
                            <!-- èƒŒé¢ (æœªç¿»é–‹) -->
                            <div class="dino-card-inner dino-card-front text-4xl transform-gpu">
                                ğŸ¥š
                            </div>
                            <!-- æ­£é¢ (å…§å®¹) -->
                            <div class="dino-card-inner dino-card-back text-gray-800 transform-gpu p-1">
                                ${innerContent}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">ğŸ¦– æé¾è›‹è©å½™é…å° (Dino Egg Match)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šæé¾è›‹ï¼Œé…å°å–®å­—å’Œ Emoji (å…± ${NUM_GAME1_CARDS / 2} çµ„)ã€‚</p>
                    <div id="dino-match-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-lg mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame1(true)" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            é‡æ–°é–‹å§‹/ä¸‹ä¸€è¼ª
                        </button>
                    </div>
                </section>
            `;
        }
        // --- Game 1 Logic End ---


        // --- Game 2 (Robot Letter Puzzle) Logic ---
        function initGame2(isInit = false) { newQuestionG2(isInit); }

        function newQuestionG2(isInit = false) {
            const sourceWords = getWordList('game2');
            if (sourceWords.length === 0) { renderGame2(true); return; }
            
            const itemObj = drawNextItem('game2');
            if (!itemObj) { initGame2(true); return; }

            const randomWord = itemObj.item.word;
            state.g2_currentQuestionItem = itemObj.item; 
            state.g2_currentWord = randomWord.toUpperCase(); 
            
            const targetLetters = state.g2_currentWord.split('');
            state.g2_shuffledLetters = shuffleArray(targetLetters).map(l => ({ 
                id: crypto.randomUUID(), 
                value: l, 
                used: false 
            }));
            
            state.g2_targetLetters = targetLetters.map(l => ({ value: l, filled: null })); 
            state.g2_userLetters = Array(targetLetters.length).fill(null); 
            
            renderGame2();
        }
        
        function handleLetterClickG2(letterId) {
            const letterObj = state.g2_shuffledLetters.find(l => l.id === letterId);
            if (!letterObj || letterObj.used) return;
            
            const targetIndex = state.g2_userLetters.findIndex(l => l === null);

            if (targetIndex !== -1) {
                state.g2_userLetters[targetIndex] = letterObj.value;
                letterObj.used = true;
                
                checkCompletionG2();
                renderGame2();
            }
        }
        
        function handleTargetClickG2(targetIndex) {
            const letterValue = state.g2_userLetters[targetIndex];
            if (!letterValue) return;

            const usedLetterObj = state.g2_shuffledLetters.find(l => l.value === letterValue && l.used);
            if (usedLetterObj) usedLetterObj.used = false;

            state.g2_userLetters[targetIndex] = null;
            renderGame2();
        }

        function checkCompletionG2() {
            if (state.g2_userLetters.some(l => l === null)) return;
            
            const guessedWord = state.g2_userLetters.join('');
            const isCorrect = guessedWord === state.g2_currentWord;
            
            if (isCorrect) {
                MessageBox.show(`å¤ªæ£’äº†ï¼æ‹¼å­—æˆåŠŸï¼š${state.g2_currentWord}ï¼ğŸ‰`, false);
                updatePools('game2', state.g2_currentQuestionItem, true);
                setTimeout(newQuestionG2, 1500);
            } else {
                MessageBox.show("æ‹¼å­—éŒ¯èª¤ï¼Œå†è©¦è©¦çœ‹ï¼", true);
                updatePools('game2', state.g2_currentQuestionItem, false);
            }
        }

        function renderGame2(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šå–®å­—åº«ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 2) æ–°å¢ã€‚</p>`;
                return;
            }

            const targetHtml = state.g2_targetLetters.map((target, index) => {
                const letter = state.g2_userLetters[index];
                const isCorrect = letter === target.value;
                const displayClass = letter ? (isCorrect ? 'bg-green-300' : 'bg-red-300') : 'bg-white';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="robot-target w-12 h-12 md:w-16 md:h-16 ${letter ? 'filled' : ''} ${displayClass} text-2xl font-bold" onclick="handleTargetClickG2(${index})">
                            ${letter ? letter.toLowerCase() : '?'}
                        </div>
                        <p class="text-xs mt-1 text-gray-500">${index + 1}</p>
                    </div>
                `;
            }).join('');

            const shuffledHtml = state.g2_shuffledLetters.map(letter => {
                const buttonClass = letter.used ? 'opacity-30 cursor-not-allowed' : 'hover:bg-yellow-400';
                return `
                    <button class="robot-part text-2xl md:text-3xl ${buttonClass}" 
                            onclick="handleLetterClickG2('${letter.id}')"
                            ${letter.used ? 'disabled' : ''}>
                        ${letter.value.toLowerCase()}
                    </button>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¤– æ©Ÿå™¨äººå­—æ¯æ‹¼åœ– (Robot Letter Puzzle)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šä¸‹æ–¹çš„å­—æ¯ï¼Œä¾åºå¡«å…¥æ­£ç¢ºä½ç½®ï¼Œæ‹¼å‡ºå–®å­—ã€‚</p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <p class="text-3xl md:text-5xl mb-4 font-extrabold text-blue-800">
                        ç›®æ¨™å–®å­—é•·åº¦: ${state.g2_currentWord.length}
                    </p>
                    
                    <button onclick="callTTS(state.g2_currentWord)" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg mb-6">
                        ğŸ”Š é»æ“Šè†è½å–®å­—
                    </button>

                    <!-- æ‹¼å­—ç›®æ¨™å€ -->
                    <div class="flex space-x-2 md:space-x-3 mb-8">
                        ${targetHtml}
                    </div>

                    <!-- æ©Ÿå™¨äººéƒ¨ä»¶ (å­—æ¯å¡Š) -->
                    <div class="flex flex-wrap justify-center gap-2 md:gap-3 p-4 bg-white rounded-lg shadow-inner border-4 border-gray-300">
                        ${shuffledHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="newQuestionG2(false)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ä¸‹ä¸€å€‹å–®å­—
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 2 Logic End ---


        // --- Game 3 (Superhero Action) Logic ---
        function initGame3(isInit = false) {
            if(isInit) state.g3_score = 0;
            newActionG3();
        }

        function newActionG3() {
            const sourceActions = getWordList('game3');
            if (sourceActions.length < 3) { renderGame3(true); return; }
            
            const itemObj = drawNextItem('game3');
            if (!itemObj) { initGame3(true); return; }
            
            const correctAnswer = itemObj.item;
            state.g3_currentQuestionItem = correctAnswer; 

            const otherActions = sourceActions.filter(a => getItemKey(a, 'game3') !== getItemKey(correctAnswer, 'game3'));
            const wrongAnswers = shuffleArray(otherActions).slice(0, 2);
            
            const allOptions = shuffleArray([correctAnswer, ...wrongAnswers]);

            state.g3_currentAction = {
                command: `${correctAnswer.verb.toUpperCase()}!`,
                correctVerb: correctAnswer.verb,
                options: allOptions,
                isGuessed: false
            };
            
            renderGame3();
            setTimeout(() => callTTS(state.g3_currentAction.command), 500);
        }

        function handleGuessG3(guessedVerb) {
            if (state.g3_currentAction.isGuessed) return;
            
            state.g3_currentAction.isGuessed = true;
            const isCorrect = guessedVerb === state.g3_currentAction.correctVerb;
            
            if (isCorrect) {
                state.g3_score++;
                MessageBox.show("BINGO! å¤ªæ£’äº†ï¼ğŸ’ª", false);
                updatePools('game3', state.g3_currentQuestionItem, true);
            } else {
                state.g3_score = Math.max(0, state.g3_score - 1);
                MessageBox.show(`ç­”éŒ¯äº†ï¼ŒæŒ‡ä»¤æ˜¯ ${state.g3_currentAction.command.toLowerCase()}ã€‚`, true);
                updatePools('game3', state.g3_currentQuestionItem, false);
            }
            
            renderGame3();
            setTimeout(newActionG3, 2000);
        }

        function renderGame3(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šå‹•ä½œæŒ‡ä»¤ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 3) æ–°å¢è‡³å°‘ 3 å€‹å‹•ä½œã€‚</p>`;
                return;
            }

            const optionsHtml = state.g3_currentAction?.options.map(option => {
                const isCorrect = option.verb === state.g3_currentAction.correctVerb;
                const isGuessed = state.g3_currentAction.isGuessed;
                
                let buttonClass = '';
                if (isGuessed) {
                    buttonClass = isCorrect ? 'bg-green-400 shadow-green-600' : 'bg-red-400 opacity-70 cursor-not-allowed';
                } else {
                    buttonClass = 'hover:bg-blue-300';
                }

                // FIX: ç§»é™¤åœ–ç‰‡/Emojiï¼Œåªé¡¯ç¤ºå‹•è©æ–‡å­—
                const verbDisplay = `<span class="verb-display text-gray-800">${option.verb}</span>`;

                return `
                    <button onclick="handleGuessG3('${option.verb}')" 
                            class="superhero-option flex flex-col items-center justify-center p-4 rounded-xl shadow-cute transition duration-200 ${buttonClass}"
                            ${isGuessed ? 'disabled' : ''}>
                        <span class="text-4xl md:text-5xl mb-2">ğŸ’¥</span> <!-- ä½¿ç”¨é€šç”¨çš„é–ƒçˆ Emoji ä½œç‚ºè¦–è¦ºæç¤º -->
                        <span class="text-xl md:text-2xl font-bold">${option.verb.toLowerCase()}</span>
                    </button>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¦¸ è¶…ç´šè‹±é›„å‹•ä½œæŒ‡ä»¤ (Superhero Action)</h2>
                    <p class="text-center text-sm mb-2">ç›®æ¨™: é»æ“Šå–‡å­è†è½æŒ‡ä»¤ï¼Œç„¶å¾Œé»æ“Šæ­£ç¢ºçš„å‹•ä½œæŒ‰éˆ•ã€‚</p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <div class="mb-4 flex justify-between w-full max-w-sm">
                        <p class="text-lg font-bold text-gray-700">å¾—åˆ†: ${state.g3_score}</p>
                        <button onclick="newActionG3()" class="text-sm bg-accent-yellow px-3 py-1 rounded-full shadow-md hover:bg-yellow-400">
                            ä¸‹ä¸€é¡Œ
                        </button>
                    </div>

                    <!-- è‹±é›„å€ (ç´”è£é£¾) -->
                    <div id="superhero-hero" class="text-9xl mb-8 transition-transform duration-500 transform-gpu">
                        ğŸ’¥
                    </div>

                    <!-- å–‡å­å’ŒæŒ‡ä»¤ -->
                    <button onclick="callTTS(state.g3_currentAction.command)" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto mb-6">
                        ğŸ”Š è†è½æŒ‡ä»¤
                    </button>

                    <!-- é¸é …æŒ‰éˆ• -->
                    <div class="grid grid-cols-3 gap-4 max-w-lg w-full">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }
        // --- Game 3 Logic End ---


        // --- Game 4 (Grammar Parking Lot) Logic ---
        function initGame4(isInit = false) {
            state.g4_isLocked = false;
            newSentenceG4();
        }

        function newSentenceG4() {
            const sourceSentences = getWordList('game4');
            if (sourceSentences.length === 0) { renderGame4(true); return; }
            
            const itemObj = drawNextItem('game4');
            if (!itemObj) { initGame4(true); return; }
            
            const newSentence = itemObj.item; 
            state.g4_currentQuestionItem = newSentence; 

            state.g4_currentSentence = {
                ...newSentence,
                shuffledOptions: shuffleArray(newSentence.options),
                userAnswer: null
            };
            state.g4_isLocked = false;
            
            renderGame4();
        }
        
        function handleParkingG4(guessedOption) {
            if (state.g4_isLocked) return;

            state.g4_isLocked = true;
            state.g4_currentSentence.userAnswer = guessedOption;

            const isCorrect = guessedOption === state.g4_currentSentence.answer;
            
            renderGame4();
            
            updatePools('game4', state.g4_currentQuestionItem, isCorrect);

            const carElement = document.getElementById('parking-car');

            if (isCorrect) {
                MessageBox.show("åœè»ŠæˆåŠŸï¼âœ…", false);
            } else {
                if (carElement) {
                    carElement.classList.add('animate-pulse');
                    setTimeout(() => carElement.classList.remove('animate-pulse'), 500);
                }
                MessageBox.show(`ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${state.g4_currentSentence.answer.toLowerCase()}ã€‚`, true);
            }
            
            setTimeout(newSentenceG4, 2500);
        }

        function renderGame4(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šå¥å‹å–®å­—åº«ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 4) æ–°å¢ã€‚</p>`;
                return;
            }

            const sentenceWithBlank = state.g4_currentSentence.pattern.replace('____', 
                `<span class="text-red-600 font-extrabold p-1 bg-yellow-200 rounded">${state.g4_isLocked ? state.g4_currentSentence.userAnswer : '____'}</span>`
            );

            const optionsHtml = state.g4_currentSentence.shuffledOptions.map((option) => {
                const isCorrect = option === state.g4_currentSentence.answer;
                const isGuessed = state.g4_isLocked && option === state.g4_currentSentence.userAnswer;
                
                let spotClass = 'parking-spot hover:shadow-lg hover:scale-[1.02]';
                if (state.g4_isLocked) {
                    spotClass = isGuessed 
                        ? (isCorrect ? 'bg-green-300 border-green-600' : 'bg-red-300 border-red-600')
                        : (isCorrect ? 'bg-yellow-300 border-yellow-600' : 'bg-gray-200 border-gray-400');
                } else {
                     spotClass += ' bg-white';
                }

                return `
                    <div onclick="handleParkingG4('${option}')" 
                         class="text-xl font-bold text-gray-800 text-center ${spotClass} transition duration-300">
                        ${option}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-2 text-center">ğŸš— äº¤é€šå·¥å…·æ–‡æ³•åœè»Šå ´ (Grammar Parking Lot)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é¸æ“‡æ­£ç¢ºçš„å–®å­—/è©çµ„ï¼Œè®“æ±½è»Šåœå…¥æ­£ç¢ºçš„åœè»Šä½ã€‚</p>
                </section>
                
                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md">
                    
                    <!-- æ±½è»Šåœ–ç¤º -->
                    <div id="parking-car" class="text-6xl mb-4 transition-transform duration-500 car-anim">
                        ğŸš—
                    </div>

                    <!-- å¥å­é¡¯ç¤ºå€ -->
                    <div class="text-3xl md:text-4xl font-semibold mb-8 p-4 bg-white rounded-lg border-4 border-gray-300">
                        ${sentenceWithBlank.toLowerCase()}
                    </div>

                    <!-- åœè»Šä½é¸é … -->
                    <div class="grid grid-cols-3 gap-4 max-w-lg w-full">
                        ${optionsHtml}
                    </div>

                    <div class="text-center mt-6">
                        <button onclick="newSentenceG4()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg" ${state.g4_isLocked ? 'disabled' : ''}>
                            è·³é / ä¸‹ä¸€é¡Œ
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 4 Logic End ---


        // --- Game 5 (Who's Lying?) Logic ---
        function initGame5(isInit = false) {
            state.g5_gameStatus = 'ready';
            newQuestionG5();
        }

        function newQuestionG5() {
            const sourceQuestions = getWordList('game5');
            if (sourceQuestions.length === 0) { renderGame5(true); return; }
            
            const itemObj = drawNextItem('game5');
            if (!itemObj) { initGame5(true); return; }

            const randomQuestion = itemObj.item;
            state.g5_currentQuestionItem = randomQuestion; 
            
            state.g5_currentStatement = {
                ...randomQuestion,
                isGuessed: false
            };
            state.g5_shaker = { true: false, false: false };
            state.g5_gameStatus = 'playing';
            renderGame5();
            
            setTimeout(() => callTTS(randomQuestion.statement), 500);
        }

        function handleGuessG5(guess) {
            if (state.g5_currentStatement.isGuessed) return;
            
            state.g5_currentStatement.isGuessed = true;
            const correctAnswer = state.g5_currentStatement.answer;
            const isCorrect = guess === correctAnswer;
            
            updatePools('game5', state.g5_currentQuestionItem, isCorrect);
            
            if (isCorrect) {
                MessageBox.show("ç­”å°äº†ï¼é€™ä½äººç‰©èªªçš„æ˜¯å¯¦è©±ï¼ğŸ‰", false);
            } else {
                const lyingPerson = guess.toLowerCase(); 
                state.g5_shaker[lyingPerson] = true;
                
                MessageBox.show("ç­”éŒ¯äº†ï¼é€™å€‹äººç‰©åœ¨èªªè¬Šï¼ğŸ¤¥", true);
            }
            
            renderGame5();
            setTimeout(newQuestionG5, 2500);
        }

        function renderGame5(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šå•é¡Œå–®å­—åº«ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 5) æ–°å¢ã€‚</p>`;
                return;
            }
            
            const statement = state.g5_currentStatement.statement.toLowerCase();
            const isGuessed = state.g5_currentStatement.isGuessed;

            const trueIsLying = isGuessed && state.g5_currentStatement.answer === 'FALSE';
            const falseIsLying = isGuessed && state.g5_currentStatement.answer === 'TRUE';
            
            const trueShaker = state.g5_shaker.true ? 'shaking' : '';
            const falseShaker = state.g5_shaker.false ? 'shaking' : '';
            
            const showTrueTongue = state.g5_shaker.true;
            const showFalseTongue = state.g5_shaker.false;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¤¥ èª°èªªè¬Šäº†? (True/False Reading)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é–±è®€çŸ­å¥ä¸¦åˆ¤æ–·çœŸå‡ (True/False)ã€‚</p>
                </section>

                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md w-full">
                    
                    <div class="mb-6 p-4 md:p-6 bg-white rounded-xl shadow-lg border-4 border-accent-yellow w-full max-w-xl text-center">
                        <h3 class="text-2xl md:text-4xl font-extrabold text-gray-800">
                            "${statement}"
                        </h3>
                    </div>
                    
                    <button onclick="callTTS(state.g5_currentStatement.statement)" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg mb-8">
                        ğŸ”Š è†è½çŸ­å¥
                    </button>

                    <!-- è§’è‰²é¸é …å€ (True vs False) -->
                    <div class="flex justify-around items-end w-full max-w-3xl">
                        
                        <!-- TRUE -->
                        <div class="flex flex-col items-center relative p-2">
                            <div id="true-character" class="text-6xl md:text-8xl p-3 mb-2 transition-transform duration-300 relative ${trueShaker}">
                                ${trueIsLying ? 'ğŸ¤¡' : 'ğŸ‘‘'}
                                ${showTrueTongue ? `<span class="tongue-container"><span class="tongue-out">ğŸ‘…</span></span>` : ''}
                            </div>
                            <button onclick="handleGuessG5('TRUE')" 
                                    class="text-2xl md:text-3xl font-extrabold py-3 px-8 rounded-2xl shadow-cute transition duration-150 
                                        ${trueIsLying ? 'bg-red-400 opacity-70 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500'}"
                                    ${isGuessed ? 'disabled' : ''}>
                                TRUE
                            </button>
                            ${isGuessed ? `<p class="text-lg font-bold mt-2 ${trueIsLying ? 'text-red-600' : 'text-green-600'}">${trueIsLying ? 'èªªè¬Šè€…' : 'èª å¯¦è€…'}</p>` : ''}
                        </div>

                        <!-- FALSE -->
                        <div class="flex flex-col items-center relative p-2">
                            <div id="false-character" class="text-6xl md:text-8xl p-3 mb-2 transition-transform duration-300 relative ${falseShaker}">
                                ${falseIsLying ? 'ğŸ¤¡' : 'ğŸ‘‘'}
                                ${showFalseTongue ? `<span class="tongue-container"><span class="tongue-out">ğŸ‘…</span></span>` : ''}
                            </div>
                            <button onclick="handleGuessG5('FALSE')" 
                                    class="text-2xl md:text-3xl font-extrabold py-3 px-8 rounded-2xl shadow-cute transition duration-150 
                                        ${falseIsLying ? 'bg-red-400 opacity-70 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500'}"
                                    ${isGuessed ? 'disabled' : ''}>
                                FALSE
                            </button>
                            ${isGuessed ? `<p class="text-lg font-bold mt-2 ${falseIsLying ? 'text-red-600' : 'text-green-600'}">${falseIsLying ? 'èªªè¬Šè€…' : 'èª å¯¦è€…'}</p>` : ''}
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button onclick="newQuestionG5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ä¸‹ä¸€å€‹å•é¡Œ
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 5 Logic End ---


        // --- Game 6 (Preposition Hunt) Logic ---
        function initGame6(isInit = false) {
            if (isInit) state.g6_score = 0;
            newQuestionG6();
        }

        function newQuestionG6() {
            const sourceQuestions = getWordList('game6');
            if (sourceQuestions.length === 0) { renderGame6(true); return; }

            const itemObj = drawNextItem('game6');
            if (!itemObj) { initGame6(true); return; }

            const question = itemObj.item;
            state.g6_currentQuestionItem = question; 

            // Combine all locations for display and shuffle them
            const locations = [
                { key: question.answerKey, url: question.urlKey, display: question.keyImage },
                { key: question.imageA, url: question.urlA, display: question.imageA },
                { key: question.imageB, url: question.urlB, display: question.imageB }
            ];
            
            let uniqueLocations = [];
            const locationKeys = new Set();
            locations.forEach(loc => {
                if (loc.key && !locationKeys.has(loc.key)) {
                    locationKeys.add(loc.key);
                    uniqueLocations.push(loc);
                }
            });

            state.g6_currentQuestion = {
                ...question,
                options: shuffleArray(uniqueLocations),
                isGuessed: false,
                guessResult: {} 
            };
            state.g6_isLocked = false;
            
            renderGame6();
            setTimeout(() => callTTS(question.instruction), 500);
        }

        function handleGuessG6(guessedKey) {
            if (state.g6_isLocked) return;

            state.g6_isLocked = true;
            const isCorrect = guessedKey === state.g6_currentQuestion.answerKey;
            
            updatePools('game6', state.g6_currentQuestionItem, isCorrect);

            state.g6_currentQuestion.isGuessed = true;
            state.g6_currentQuestion.guessResult[guessedKey] = isCorrect ? 'correct' : 'incorrect';
            
            if (isCorrect) {
                MessageBox.show("æ‰¾åˆ°äº†ï¼ğŸ—ºï¸ æŒ‡ä»¤æ­£ç¢ºï¼", false);
                state.g6_score = (state.g6_score || 0) + 1;
            } else {
                MessageBox.show(`ç­”éŒ¯äº†ï¼Œç­”æ¡ˆæ˜¯ ${state.g6_currentQuestion.answerKey} æ‰€åœ¨åœ°ã€‚`, true);
            }

            renderGame6();
            setTimeout(newQuestionG6, 2500);
        }

        function renderGame6(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game6') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šå•é¡Œå–®å­—åº«ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 6) æ–°å¢ã€‚</p>`;
                return;
            }
            
            const statement = state.g6_currentQuestion.instruction.toLowerCase();
            const isGuessed = state.g6_currentQuestion.isGuessed;

            const locationsHtml = state.g6_currentQuestion.options.map(loc => {
                const isAnswer = loc.key === state.g6_currentQuestion.answerKey;
                let spotClass = isGuessed 
                    ? (isAnswer ? 'correct' : (state.g6_currentQuestion.guessResult[loc.key] === 'incorrect' ? 'incorrect' : 'bg-gray-200 cursor-default'))
                    : 'hover:scale-[1.05]';

                // æ ¹æ“šæ˜¯å¦æœ‰ URL æ±ºå®šé¡¯ç¤ºåœ–ç‰‡é‚„æ˜¯ Emoji/æ–‡å­—
                const locationContent = loc.url
                    ? `<img src="${loc.url}" alt="${loc.display}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/A0A0A0/FFFFFF?text=${loc.display.replace(/\s/g, '+')}'" class="w-20 h-20"/>`
                    : `<span class="content">${loc.display}</span>`;
                
                return `
                    <div onclick="handleGuessG6('${loc.key}')" 
                         data-key="${loc.key}"
                         class="location-spot ${spotClass} transition duration-300 ${isGuessed ? 'pointer-events-none' : ''}">
                        ${locationContent}
                        <p class="text-sm font-semibold text-gray-700">${loc.display.toLowerCase()}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-2 text-center">ğŸ—ºï¸ ä»‹ç³»è©å°‹å¯¶ (Preposition Hunt)</h2>
                    <p class="text-center text-sm mb-2">ç›®æ¨™: é»æ“Šå–‡å­è†è½æŒ‡ä»¤ï¼Œæ‰¾å‡ºåœ°åœ–ä¸Šæ­£ç¢ºçš„åœ°é»ã€‚</p>
                    <p class="text-center text-xs text-gray-700 mb-4">å¾—åˆ†: ${state.g6_score}</p>
                </section>

                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md w-full">
                    
                    <div class="mb-6 p-4 md:p-6 bg-white rounded-xl shadow-lg border-4 border-primary-pink w-full max-w-xl text-center">
                        <h3 class="text-2xl md:text-3xl font-bold text-gray-800">
                            ${statement}
                        </h3>
                    </div>
                    
                    <button onclick="callTTS(state.g6_currentQuestion.instruction)" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg mb-8">
                        ğŸ”Š è†è½æŒ‡ä»¤
                    </button>

                    <!-- åœ°åœ–å€åŸŸ -->
                    <div class="city-map w-full max-w-lg">
                        ${locationsHtml}
                    </div>

                    <div class="text-center mt-8">
                        <button onclick="newQuestionG6()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ä¸‹ä¸€å€‹å•é¡Œ
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 6 Logic End ---

        
        // --- Game 7 (Comparative Portal) Logic ---
        function initGame7(isInit = false) {
            if (isInit) state.g7_score = 0;
            newQuestionG7();
        }

        function newQuestionG7() {
            const sourceQuestions = getWordList('game7');
            if (sourceQuestions.length === 0) { renderGame7(true); return; }

            const itemObj = drawNextItem('game7');
            if (!itemObj) { initGame7(true); return; }

            const question = itemObj.item;
            state.g7_currentQuestionItem = question; 
            
            const correctComp = question.comparative;
            const allComparatives = ["LONGER", "SHORTER", "PRETTIER", "BETTER", "FASTER", "SLOWER", "BIGGER", "SMALLER"];
            
            let wrongOptions = allComparatives.filter(c => c !== correctComp).sort(() => 0.5 - Math.random());
            
            let options = new Set([correctComp]);
            while (options.size < 4 && wrongOptions.length > 0) {
                options.add(wrongOptions.pop());
            }

            // éš¨æ©Ÿæ±ºå®šé¡Œå‹ï¼šA is ___ than B é‚„æ˜¯ B is ___ than A
            const comparisonType = Math.random() < 0.5 ? 'A_THAN_B' : 'B_THAN_A';
            
            // æ ¹æ“šé¡Œå‹èª¿æ•´é¡Œç›®é¡¯ç¤º
            let questionText;
            if (comparisonType === 'A_THAN_B') {
                // FIX: ç§»é™¤å½¢å®¹è©ï¼Œåªç•™ç©ºæ ¼
                questionText = `è«‹é¸å‡º A æ¯” B ____?`;
            } else {
                 // FIX: ç§»é™¤å½¢å®¹è©ï¼Œåªç•™ç©ºæ ¼
                 questionText = `è«‹é¸å‡º B æ¯” A ____?`;
            }


            state.g7_currentQuestion = {
                ...question,
                options: shuffleArray(Array.from(options)),
                isGuessed: false,
                comparisonType: comparisonType,
                questionText: questionText,
                // ä¿®æ­£ï¼šå¥å­æ‡‰ç‚ºå®Œæ•´å¥å­
                sentence: `THE ${question.noun} IS ${question.comparative}.` 
            };
            state.g7_isLocked = false;
            
            renderGame7();
        }

        function handleGuessG7(guessedComparative) {
            if (state.g7_isLocked) return;

            state.g7_isLocked = true;
            const isCorrect = guessedComparative === state.g7_currentQuestion.comparative;
            
            updatePools('game7', state.g7_currentQuestionItem, isCorrect);

            state.g7_currentQuestion.isGuessed = true;

            if (isCorrect) {
                MessageBox.show("å‚³é€æˆåŠŸï¼âœ¨ æ¯”è¼ƒæ­£ç¢ºï¼", false);
                state.g7_score = (state.g7_score || 0) + 1;
            } else {
                MessageBox.show(`å‚³é€å¤±æ•—ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ ${state.g7_currentQuestion.comparative.toLowerCase()}ã€‚`, true);
            }
            
            renderGame7();
            callTTS(state.g7_currentQuestion.sentence);

            setTimeout(newQuestionG7, 3500);
        }

        function renderGame7(wordError = false) {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game7') return;

            if (wordError) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼šæ¯”è¼ƒç´šå¥å‹ä¸è¶³ï¼è«‹å‰å¾€å–®å­—å¾Œå° (éŠæˆ² 7) æ–°å¢ã€‚</p>`;
                return;
            }

            const current = state.g7_currentQuestion;
            const isGuessed = current.isGuessed;

            const optionsHtml = current.options.map(option => {
                const isCorrect = option === current.comparative;
                const buttonClass = isGuessed
                    ? (isCorrect ? 'correct opacity-100' : 'bg-gray-300 opacity-60 cursor-default')
                    : 'hover:bg-blue-300';
                
                return `
                    <button onclick="handleGuessG7('${option}')" 
                            class="portal-button py-3 px-6 rounded-xl shadow-cute text-xl font-bold transition duration-200 ${buttonClass}"
                            ${isGuessed ? 'disabled' : ''}>
                        ${option.toLowerCase()}
                    </button>
                `;
            }).join('');
            
            const defaultPlaceholder = "https://placehold.co/150x150/A0A0A0/FFFFFF?text=IMAGE";

            const itemAImage = `<img src="${current.urlA || defaultPlaceholder}" alt="Item A" onerror="this.onerror=null; this.src='https://placehold.co/150x150/FFEC99/333?text=A'" class="w-32 h-32 md:w-40 md:h-40"/>`;
            const itemBImage = `<img src="${current.urlB || defaultPlaceholder}" alt="Item B" onerror="this.onerror=null; this.src='https://placehold.co/150x150/FFEC99/333?text=B'" class="w-32 h-32 md:w-40 md:h-40"/>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">âš–ï¸ æ¯”è¼ƒç´šå‚³é€é–€ (Comparative Portal)</h2>
                    <p class="text-center text-sm mb-2">ç›®æ¨™: è§€å¯Ÿå…©ä»¶ç‰©å“ï¼Œé¸æ“‡æ­£ç¢ºçš„æ¯”è¼ƒç´šå½¢å®¹è©ã€‚</p>
                    <p class="text-center text-xs text-gray-700 mb-4">å¾—åˆ†: ${state.g7_score}</p>
                </section>

                <div class="flex flex-col items-center p-6 bg-keyboard-bg rounded-xl shadow-md w-full">
                    
                    <!-- ç‰©å“å°æ¯”å€ -->
                    <div class="flex justify-around items-end w-full max-w-md mb-8 space-x-4">
                        <!-- ç‰©å“ A -->
                        <div class="flex flex-col items-center">
                            <div class="portal-item">${itemAImage}</div>
                            <p class="text-lg mt-2 text-gray-700">A (${current.noun.toLowerCase()})</p>
                        </div>
                        
                        <!-- ç‰©å“ B -->
                        <div class="flex flex-col items-center">
                            <div class="portal-item">${itemBImage}</div>
                            <p class="text-lg mt-2 text-gray-700">B (${current.noun.toLowerCase()})</p>
                        </div>
                    </div>
                    
                    <!-- ç­”æ¡ˆé¡¯ç¤ºå€ -->
                    <div class="mb-6 p-4 bg-white rounded-lg shadow-inner border-4 border-gray-300 w-full max-w-xl text-center">
                        <p class="text-lg font-semibold text-gray-600 mb-2">${isGuessed ? 'å®Œæ•´æ¯”è¼ƒå¥:' : current.questionText}</p>
                        <h3 class="text-2xl md:text-3xl font-extrabold text-red-700">
                            ${isGuessed ? current.sentence.toLowerCase() : '____'}
                        </h3>
                    </div>

                    <!-- é¸é …æŒ‰éˆ• -->
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        ${optionsHtml}
                    </div>

                    <div class="text-center mt-8">
                        <button onclick="newQuestionG7()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ä¸‹ä¸€å€‹å•é¡Œ
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 7 Logic End ---


        // --- Admin Panel Logic ---
        const ADMIN_TABS = [
            { key: 'game1', name: 'ğŸ¦– è©å½™é…å°', minRequired: MIN_REQUIRED_MAP.game1, dataKeys: ["word", "emoji"], placeholder: ["å–®å­— (T-REX)", "Emoji (ğŸ¦–)"] },
            { key: 'game2', name: 'ğŸ¤– å­—æ¯æ‹¼åœ–', minRequired: MIN_REQUIRED_MAP.game2, dataKeys: ["word"], placeholder: ["å–®å­— (ROBOT)"] },
            { key: 'game3', name: 'ğŸ¦¸ å‹•ä½œæŒ‡ä»¤', minRequired: MIN_REQUIRED_MAP.game3, dataKeys: ["verb", "emoji"], placeholder: ["å‹•ä½œ (JUMP)", "Emoji (â¬†ï¸, å¯é¸ä½†ç„¡ç”¨)"] },
            { key: 'game4', name: 'ğŸš— æ–‡æ³•åœè»Š', minRequired: MIN_REQUIRED_MAP.game4, dataKeys: ["pattern", "options", "answer"], placeholder: ["å¥å‹ (____)", "é¸é … (AM,IS,ARE)", "ç­”æ¡ˆ (AM)"] },
            { key: 'game5', name: 'ğŸ¤¥ èª°èªªè¬Šäº†?', minRequired: MIN_REQUIRED_MAP.game5, dataKeys: ["statement", "answer"], placeholder: ["é™³è¿°å¥", "ç­”æ¡ˆ (TRUE/FALSE)"] },
            { key: 'game6', name: 'ğŸ—ºï¸ ä»‹ç³»è©å°‹å¯¶', minRequired: MIN_REQUIRED_MAP.game6, dataKeys: ["instruction", "keyImage", "imageA", "imageB", "urlKey", "urlA", "urlB"], placeholder: ["æŒ‡ä»¤", "ç­”æ¡ˆåœ–ç¤º/Emoji", "åœ–ç¤º A", "åœ–ç¤º B", "URL Ans (é¸å¡«)", "URL A (é¸å¡«)", "URL B (é¸å¡«)"] },
            { key: 'game7', name: 'âš–ï¸ æ¯”è¼ƒç´š', minRequired: MIN_REQUIRED_MAP.game7, dataKeys: ["noun", "adj", "comparative", "urlA", "urlB"], placeholder: ["åè© (SNAKE)", "å½¢å®¹è© (LONG)", "æ¯”è¼ƒç´š (LONGER)", "URL A (é¸å¡«)", "URL B (é¸å¡«)"] }
        ];
        let currentAdminKey = ADMIN_TABS[0].key;

        function getCurrentAdminTab() {
            return ADMIN_TABS.find(t => t.key === currentAdminKey);
        }

        function setCurrentAdminKey(key) {
            currentAdminKey = key;
            renderWordAdmin();
        }

        function addWordAdmin() {
            if (isGeneratingImage) return;

            const tab = getCurrentAdminTab();
            
            // Collect inputs
            const inputs = {};
            inputs.input1 = document.getElementById('admin-input-1')?.value.trim().toUpperCase();
            inputs.input2 = document.getElementById('admin-input-2')?.value.trim(); // ä¿æŒ case for Emoji/Options
            inputs.input3 = document.getElementById('admin-input-3')?.value.trim();
            inputs.input4 = document.getElementById('admin-input-4')?.value.trim();
            inputs.input5 = document.getElementById('admin-input-5')?.value.trim();
            inputs.input6 = document.getElementById('admin-input-6')?.value.trim();
            inputs.input7 = document.getElementById('admin-input-7')?.value.trim();


            let newEntry = null;

            if (tab.key === 'game1') {
                 // word, emoji
                if (!inputs.input1 || !inputs.input2) { MessageBox.show("è«‹å¡«å¯«å–®å­—å’Œ Emojiï¼", true); return; }
                newEntry = { id: crypto.randomUUID(), word: inputs.input1, emoji: inputs.input2 };

            } else if (tab.key === 'game2') {
                // word
                if (!inputs.input1) { MessageBox.show("è«‹å¡«å¯«å–®å­—ï¼", true); return; }
                newEntry = { id: crypto.randomUUID(), word: inputs.input1 };

            } else if (tab.key === 'game3') {
                // verb, emoji (only verb is used in game, but saving structure for consistency)
                if (!inputs.input1) { MessageBox.show("è«‹å¡«å¯«å‹•ä½œå–®å­—ï¼", true); return; }
                newEntry = { id: crypto.randomUUID(), verb: inputs.input1, emoji: inputs.input2 || 'â“' }; // Emoji is optional/filler

            } else if (tab.key === 'game4') {
                // pattern, options (comma-separated), answer
                if (!inputs.input1 || !inputs.input2 || !inputs.input3) { MessageBox.show("è«‹å¡«å¯«å¥å‹ã€é¸é …å’Œç­”æ¡ˆï¼", true); return; }
                const optionsArray = inputs.input2.split(',').map(o => o.trim().toUpperCase()).filter(o => o.length > 0);
                newEntry = { id: crypto.randomUUID(), pattern: inputs.input1, options: optionsArray, answer: inputs.input3 };

            } else if (tab.key === 'game5') {
                // statement, answer (TRUE/FALSE)
                if (!inputs.input1 || !inputs.input2 || (inputs.input2.toUpperCase() !== 'TRUE' && inputs.input2.toUpperCase() !== 'FALSE')) { MessageBox.show("è«‹å¡«å¯«é™³è¿°å¥ï¼Œç­”æ¡ˆå¿…é ˆæ˜¯ TRUE æˆ– FALSEï¼", true); return; }
                newEntry = { id: crypto.randomUUID(), statement: inputs.input1, answer: inputs.input2.toUpperCase() };

            } else if (tab.key === 'game6') {
                 // instruction, keyImage, imageA, imageB, urlKey, urlA, urlB
                if (!inputs.input1 || !inputs.input2 || !inputs.input3 || !inputs.input4) { MessageBox.show("è«‹å¡«å¯«æŒ‡ä»¤å’Œè‡³å°‘ä¸‰å€‹ä½ç½®åœ–ç¤º/Emojiï¼", true); return; }
                newEntry = {
                    id: crypto.randomUUID(), instruction: inputs.input1, keyImage: inputs.input2, 
                    imageA: inputs.input3, imageB: inputs.input4, answerKey: inputs.input2,
                    urlKey: inputs.input5 || '', urlA: inputs.input6 || '', urlB: inputs.input7 || ''
                };

            } else if (tab.key === 'game7') {
                // noun, adj, comparative, urlA, urlB
                if (!inputs.input1 || !inputs.input2 || !inputs.input3) { MessageBox.show("è«‹å¡«å¯«åè©ã€å½¢å®¹è©å’Œæ¯”è¼ƒç´šï¼", true); return; }
                newEntry = {
                    id: crypto.randomUUID(), noun: inputs.input1, adj: inputs.input2, comparative: inputs.input3,
                    urlA: inputs.input4 || '', urlB: inputs.input5 || '' 
                };
            }
            
            if (!newEntry) { MessageBox.show("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚", true); return; }

            // Simple duplicate check before final save
            const list = localCustomWords[tab.key];
            const entryKey = getItemKey(newEntry, tab.key);
            if (list.some(item => getItemKey(item, tab.key) === entryKey)) {
                MessageBox.show("è©å½™å·²å­˜åœ¨ï¼", true); return;
            }

            localCustomWords[tab.key].push(newEntry);
            saveWordsToLocal();
            MessageBox.show(`è©å½™æ–°å¢æˆåŠŸï¼`, false);
            
            // Clear inputs and rerender
            document.getElementById('admin-input-1').value = '';
            document.getElementById('admin-input-2').value = '';
            document.getElementById('admin-input-3').value = '';
            if (document.getElementById('admin-input-4')) document.getElementById('admin-input-4').value = '';
            if (document.getElementById('admin-input-5')) document.getElementById('admin-input-5').value = '';
            if (document.getElementById('admin-input-6')) document.getElementById('admin-input-6').value = '';
            if (document.getElementById('admin-input-7')) document.getElementById('admin-input-7').value = '';

            renderWordAdmin();
        }

        function deleteWordAdmin(id) {
            if (isGeneratingImage) { MessageBox.show("åœ–ç‰‡ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true); return; }
            
            const list = localCustomWords[currentAdminKey];
            const initialLength = list.length;

            localCustomWords[currentAdminKey] = list.filter(item => item.id !== id);
            
            if (localCustomWords[currentAdminKey].length < initialLength) {
                saveWordsToLocal();
                MessageBox.show("è©å½™åˆªé™¤æˆåŠŸï¼", false);
            } else {
                 MessageBox.show("è©å½™åˆªé™¤å¤±æ•—ï¼Œæ‰¾ä¸åˆ°è©² IDã€‚", true);
            }
            
            renderWordAdmin();
        }

        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const tab = getCurrentAdminTab();
            const currentList = localCustomWords[tab.key] || [];
            
            const listCount = currentList.length;
            const minRequired = tab.minRequired;
            const isReady = listCount >= minRequired;

            let inputContent = '';
            let inputPlaceholders = tab.placeholder;
            
            // Render input layout dynamically
            if (tab.key === 'game4') {
                 inputContent = `
                    <input type="text" id="admin-input-1" placeholder="${inputPlaceholders[0]}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase mb-2">
                    <div class="flex space-x-2 w-full">
                        <input type="text" id="admin-input-2" placeholder="${inputPlaceholders[1]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                        <input type="text" id="admin-input-3" placeholder="${inputPlaceholders[2]}" class="w-1/4 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    </div>
                 `;
            } else if (tab.key === 'game7') {
                 inputContent = `
                    <div class="flex space-x-2 w-full mb-2">
                         <input type="text" id="admin-input-1" placeholder="${inputPlaceholders[0]}" class="w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                         <input type="text" id="admin-input-2" placeholder="${inputPlaceholders[1]}" class="w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                         <input type="text" id="admin-input-3" placeholder="${inputPlaceholders[2]}" class="w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    </div>
                    <div class="flex space-x-2 w-full">
                         <input type="text" id="admin-input-4" placeholder="${inputPlaceholders[3]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                         <input type="text" id="admin-input-5" placeholder="${inputPlaceholders[4]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                    </div>
                 `;
            } else if (tab.key === 'game6') {
                 inputContent = `
                    <input type="text" id="admin-input-1" placeholder="${inputPlaceholders[0]}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue mb-2">
                    <div class="flex space-x-2 w-full mb-2">
                         <input type="text" id="admin-input-2" placeholder="${inputPlaceholders[1]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                         <input type="text" id="admin-input-3" placeholder="${inputPlaceholders[2]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                         <input type="text" id="admin-input-4" placeholder="${inputPlaceholders[3]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    </div>
                     <div class="flex space-x-2 w-full">
                         <input type="text" id="admin-input-5" placeholder="${inputPlaceholders[4]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                         <input type="text" id="admin-input-6" placeholder="${inputPlaceholders[5]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                         <input type="text" id="admin-input-7" placeholder="${inputPlaceholders[6]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                     </div>
                 `;
            } else if (tab.key === 'game2' || tab.key === 'game5') {
                 inputContent = `<div class="flex space-x-2 w-full">
                    <input type="text" id="admin-input-1" placeholder="${inputPlaceholders[0]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    <input type="text" id="admin-input-2" placeholder="${inputPlaceholders[1]}" class="w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    </div>`;
            } else if (tab.key === 'game1' || tab.key === 'game3') {
                // game1: word, emoji. game3: verb, emoji (optional)
                inputContent = `<div class="flex space-x-2 w-full">
                    <input type="text" id="admin-input-1" placeholder="${inputPlaceholders[0]}" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                    <input type="text" id="admin-input-2" placeholder="${inputPlaceholders[1]}" class="w-1/3 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue">
                    </div>`;
            }

            const wordListHtml = currentList.map((item, index) => {
                // FIX: ç¢ºä¿ display é¡¯ç¤ºæ‰€æœ‰ç›¸é—œå±¬æ€§
                let display = '';
                if (tab.key === 'game1') display = `${item.word} (${item.emoji})`;
                else if (tab.key === 'game3') display = `${item.verb}`;
                else if (tab.key === 'game7') display = `${item.noun} / ${item.adj} -> ${item.comparative} | URLs: ${item.urlA || 'N/A'}, ${item.urlB || 'N/A'}`;
                else display = JSON.stringify(item).replace(/"/g, '').replace(/{|}/g, '').toUpperCase();
                
                return `
                    <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                        <span class="text-sm md:text-lg font-bold text-gray-800">${index + 1}. ${display}</span>
                        <button onclick="deleteWordAdmin('${item.id}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </li>
                `;
            }).join('');

            const isImageGame = (tab.key === 'game6' || tab.key === 'game7');
            let addButtonText = 'â• æ–°å¢';


            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 id="main-title" class="text-xl md:text-3xl font-bold text-white mb-2 text-center">è‹±æ–‡éŠæˆ²æ¨‚åœ’ - ç©å®¶: ${playerName}</h2>
                    <p class="text-center text-sm text-pink-100">ğŸ’¡ é€™è£¡çš„è©å½™åƒ…å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ä¸­ã€‚</p>
                </section>
                
                <div class="flex flex-wrap justify-center space-x-1 mb-4">
                    ${ADMIN_TABS.map(t => `<button onclick="setCurrentAdminKey('${t.key}')" class="tab-btn py-2 px-3 ${currentAdminKey === t.key ? 'bg-secondary-blue text-blue-900 shadow-lg' : 'bg-gray-100 text-gray-700'}">${t.name}</button>`).join('')}
                </div>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢ ${tab.name} è©å½™</h3>
                    
                    <p class="text-xs ${isReady ? 'text-green-600' : 'text-red-600'} font-bold mb-3">
                        ${isReady ? 'âœ… è©å½™é‡è¶³å¤ ï¼ŒéŠæˆ²æº–å‚™å°±ç·’ï¼' : `â— è©²éŠæˆ²éœ€è¦è‡³å°‘ ${minRequired} å€‹é …ç›®æ‰èƒ½é–‹å§‹ (ç›®å‰ ${listCount} å€‹)`}
                    </p>

                    ${inputContent}

                    <button id="admin-add-button" onclick="addWordAdmin()"Â 
                            class="w-full bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150 mt-4"
                            ${isGeneratingImage ? 'disabled' : ''}>
                        ${addButtonText}
                    </button>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${tab.name} åˆ—è¡¨ (${currentList.length} å€‹)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰è©å½™ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                    <p class="text-xs text-gray-400 mt-4 text-center">æ‚¨çš„è¨­å®šå·²è‡ªå‹•å„²å­˜ã€‚</p>
                </div>
            `;
        }
    </script>
</body>
</html>
